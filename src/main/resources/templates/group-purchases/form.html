<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${groupBuy != null ? '공동구매 수정' : '공동구매 작성'} + ' - RecipeMate'">공동구매 작성 - RecipeMate</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body class="bg-light">
    <!-- Header Fragment -->
    <div th:replace="~{fragments/header :: header}"></div>
    
    <main class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Page Header -->
                <div class="mb-4">
                    <h1 class="fw-bold">
                        <i class="bi bi-basket3"></i>
                        <span th:text="${groupBuy != null ? '공동구매 수정' : (recipe != null ? '레시피 기반 공동구매 작성' : '공동구매 작성')}">공동구매 작성</span>
                    </h1>
                    <p class="text-muted" th:text="${recipe != null ? '레시피 재료를 선택하고 공동구매를 만들어보세요' : '함께 구매할 상품의 정보를 입력해주세요'}">함께 구매할 상품의 정보를 입력해주세요</p>
                </div>
                
                <!-- Flash Messages -->
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-circle"></i> <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <!-- Form Card -->
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <form id="groupBuyForm" method="post" 
                              th:action="${groupBuy != null ? '/group-purchases/' + groupBuy.id : (recipe != null ? '/group-purchases/recipe-based' : '/group-purchases')}"
                              enctype="multipart/form-data">
                            <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            
                            <!-- Recipe Info Section (레시피 기반 공구인 경우만 표시) -->
                            <div th:if="${recipe != null}" class="alert alert-info mb-4">
                                <div class="d-flex align-items-center">
                                    <img th:if="${recipe.imageUrl != null}" 
                                         th:src="${recipe.imageUrl}" 
                                         th:alt="${recipe.name}" 
                                         class="rounded me-3"
                                         style="width: 80px; height: 80px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                        <h5 class="mb-1 fw-bold">
                                            <i class="bi bi-egg-fried"></i> <span th:text="${recipe.name}">레시피명</span>
                                        </h5>
                                        <p class="mb-0 small text-muted">
                                            <span th:text="${recipe.category}">카테고리</span>
                                            <span th:if="${recipe.area != null}"> · <span th:text="${recipe.area}">지역</span></span>
                                        </p>
                                    </div>
                                </div>
                                <!-- Hidden fields for recipe info -->
                                <input type="hidden" name="recipeApiId" th:value="${recipe.id}">
                                <input type="hidden" name="recipeName" th:value="${recipe.name}">
                                <input type="hidden" name="recipeImageUrl" th:value="${recipe.imageUrl}">
                            </div>
                            
                            <!-- Ingredients Selection (레시피 기반 공구인 경우만 표시) -->
<div th:if="${recipe != null}" class="mb-4">
                                <label class="form-label fw-semibold">
                                    필요한 재료 선택 <span class="text-danger">*</span>
                                </label>
                                <div class="card">
                                    <div class="card-body">
                                        <p class="text-muted small mb-3">
                                            <i class="bi bi-info-circle"></i> 공동구매에 포함할 재료를 선택하세요. 분량은 수정할 수 있습니다.
                                        </p>
                                        <div class="row g-2" id="ingredientsList">
                                            <div th:each="ingredient, stat : ${recipe.ingredients}" class="col-md-6">
                                                <div class="border rounded p-3 ingredient-item">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input ingredient-checkbox" 
                                                               type="checkbox" 
                                                               th:id="'ingredient-' + ${stat.index}"
                                                               th:data-name="${ingredient.name}"
                                                               th:data-measure="${ingredient.measure}"
                                                               checked>
                                                        <label class="form-check-label fw-semibold" th:for="'ingredient-' + ${stat.index}">
                                                            <span th:text="${ingredient.name}">재료명</span>
                                                        </label>
                                                    </div>
                                                    <input type="text" 
                                                           class="form-control form-control-sm ingredient-measure" 
                                                           th:id="'measure-' + ${stat.index}"
                                                           th:value="${ingredient.measure}"
                                                           placeholder="분량 (예: 200g, 2개)">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="addIngredientBtn">
                                                <i class="bi bi-plus-circle"></i> 재료 추가
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hidden input for selected ingredients JSON -->
                                <input type="hidden" id="selectedIngredientsJson" name="selectedIngredientsJson">
                            </div>
                            
                            <!-- Title -->
                            <div class="mb-4">
                                <label for="title" class="form-label fw-semibold">
                                    제목 <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       id="title" 
                                       name="title" 
                                       class="form-control" 
                                       th:value="${groupBuy?.title != null ? groupBuy.title : (recipe != null ? recipe.name + ' 재료 공동구매' : '')}"
                                       placeholder="공동구매 제목을 입력하세요"
                                       required
                                       maxlength="100">
                            </div>
                            
                            <!-- Category -->
                            <div class="mb-4">
                                <label for="category" class="form-label fw-semibold">
                                    카테고리 <span class="text-danger">*</span>
                                </label>
                                <select id="category" name="category" class="form-select" required>
                                    <option value="">카테고리를 선택하세요</option>
                                    <option value="육류" th:selected="${groupBuy?.category == '육류' or (recipe != null and recipe.category == 'Beef')}">육류</option>
                                    <option value="채소" th:selected="${groupBuy?.category == '채소' or (recipe != null and recipe.category == 'Vegetarian')}">채소</option>
                                    <option value="과일" th:selected="${groupBuy?.category == '과일'}">과일</option>
                                    <option value="수산물" th:selected="${groupBuy?.category == '수산물' or (recipe != null and recipe.category == 'Seafood')}">수산물</option>
                                    <option value="유제품" th:selected="${groupBuy?.category == '유제품'}">유제품</option>
                                    <option value="기타" th:selected="${groupBuy?.category == '기타' or (recipe != null and groupBuy == null)}">기타</option>
                                </select>
                            </div>
                            
                            <!-- Content -->
                            <div class="mb-4">
                                <label for="content" class="form-label fw-semibold">
                                    상세 설명 <span class="text-danger">*</span>
                                </label>
                                <textarea id="content" 
                                          name="content" 
                                          class="form-control" 
                                          rows="8"
                                          placeholder="공동구매에 대한 상세한 설명을 입력하세요"
                                          required
                                          th:text="${groupBuy?.content != null ? groupBuy.content : (recipe != null ? recipe.name + ' 레시피에 필요한 재료들을 공동구매합니다!\n\n아래 재료들을 함께 구매하면 더 저렴하게 구입할 수 있습니다.' : '')}"></textarea>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> 상품의 상태, 수령 방법 등을 자세히 작성해주세요.
                                </div>
                            </div>
                            
                            <div class="row">
                                <!-- Total Price -->
                                <div class="col-md-6 mb-4">
                                    <label for="totalPrice" class="form-label fw-semibold">
                                        총 가격 <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" 
                                               id="totalPrice" 
                                               name="totalPrice" 
                                               class="form-control" 
                                               th:value="${groupBuy?.totalPrice}" 
                                               min="0" 
                                               step="1000"
                                               placeholder="0"
                                               required>
                                        <span class="input-group-text">원</span>
                                    </div>
                                </div>
                                
                                <!-- Target Headcount -->
                                <div class="col-md-6 mb-4">
                                    <label for="targetHeadcount" class="form-label fw-semibold">
                                        목표 인원 <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" 
                                               id="targetHeadcount" 
                                               name="targetHeadcount" 
                                               class="form-control" 
                                               th:value="${groupBuy?.targetHeadcount}" 
                                               min="2" 
                                               max="100"
                                               placeholder="2"
                                               required>
                                        <span class="input-group-text">명</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Deadline -->
                            <div class="mb-4">
                                <label for="deadline" class="form-label fw-semibold">
                                    마감일 <span class="text-danger">*</span>
                                </label>
                                <input type="datetime-local" 
                                       id="deadline" 
                                       name="deadline" 
                                       class="form-control"
                                       th:value="${groupBuy != null and groupBuy.deadline != null ? #temporals.format(groupBuy.deadline, 'yyyy-MM-dd''T''HH:mm') : ''}" 
                                       required>
                            </div>
                            
                            <hr class="my-4">
                            
                            <h5 class="fw-bold mb-3">배송 정보</h5>
                            
                            <!-- Delivery Method -->
                            <div class="mb-4">
                                <label for="deliveryMethod" class="form-label fw-semibold">
                                    배송 방법 <span class="text-danger">*</span>
                                </label>
                                <select id="deliveryMethod" name="deliveryMethod" class="form-select" required>
                                    <option value="">배송 방법을 선택하세요</option>
                                    <option value="DIRECT" th:selected="${groupBuy?.deliveryMethod?.name() == 'DIRECT'}">
                                        <i class="bi bi-person-arms-up"></i> 직거래
                                    </option>
                                    <option value="PARCEL" th:selected="${groupBuy?.deliveryMethod?.name() == 'PARCEL'}">
                                        <i class="bi bi-box-seam"></i> 택배
                                    </option>
                                    <option value="BOTH" th:selected="${groupBuy?.deliveryMethod?.name() == 'BOTH'}">
                                        <i class="bi bi-check-all"></i> 둘 다 가능
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Meetup Location -->
                            <div class="mb-4">
                                <label for="meetupLocation" class="form-label fw-semibold">
                                    만남 장소 <span class="text-muted small">(직거래 시)</span>
                                </label>
                                <input type="text" 
                                       id="meetupLocation" 
                                       name="meetupLocation" 
                                       class="form-control" 
                                       th:value="${groupBuy?.meetupLocation}"
                                       placeholder="예: 서울역 3번 출구">
                                <div class="form-text">
                                    <i class="bi bi-geo-alt"></i> 구체적인 만남 장소를 입력해주세요.
                                </div>
                            </div>
                            
                            <!-- Parcel Fee -->
                            <div class="mb-4">
                                <label for="parcelFee" class="form-label fw-semibold">
                                    택배비 <span class="text-muted small">(택배 배송 시)</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" 
                                           id="parcelFee" 
                                           name="parcelFee" 
                                           class="form-control" 
                                           th:value="${groupBuy?.parcelFee}" 
                                           min="0"
                                           step="500"
                                           placeholder="0">
                                    <span class="input-group-text">원</span>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <!-- Participant List Public -->
                            <div class="mb-4">
                                <div class="form-check">
                                    <!-- Hidden input to ensure false is sent when unchecked -->
                                    <input type="hidden" name="isParticipantListPublic" value="false">
                                    <input type="checkbox" 
                                           class="form-check-input" 
                                           id="isParticipantListPublic" 
                                           name="isParticipantListPublic"
                                           value="true"
                                           th:checked="${groupBuy?.isParticipantListPublic}">
                                    <label class="form-check-label" for="isParticipantListPublic">
                                        <i class="bi bi-people"></i> 참여자 명단 공개
                                    </label>
                                    <div class="form-text">참여자 목록을 다른 사용자에게 공개합니다.</div>
                                </div>
                            </div>
                            
                            <!-- Image Upload (only for new posts) -->
                            <div th:if="${groupBuy == null}" class="mb-4">
                                <label for="imageFiles" class="form-label fw-semibold">
                                    이미지 업로드 <span class="text-muted small">(최대 3장)</span>
                                </label>
                                <input type="file" 
                                       id="imageFiles" 
                                       name="imageFiles" 
                                       class="form-control" 
                                       multiple 
                                       accept="image/*">
                                <div class="form-text">
                                    <i class="bi bi-image"></i> JPG, PNG 형식의 이미지를 업로드할 수 있습니다.
                                </div>
                            </div>
                            
                            <!-- Form Actions -->
                            <div class="d-flex gap-2 mt-4">
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="bi bi-check-circle"></i>
                                    <span th:text="${groupBuy != null ? '수정하기' : '작성하기'}">작성하기</span>
                                </button>
                                <a th:href="${groupBuy != null ? '/group-purchases/' + groupBuy.id : '/group-purchases/list'}" 
                                   class="btn btn-outline-secondary px-4">
                                    <i class="bi bi-x-circle"></i> 취소
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Help Card -->
                <div class="card border-0 bg-light mt-3">
                    <div class="card-body">
                        <h6 class="fw-semibold mb-2">
                            <i class="bi bi-lightbulb text-warning"></i> 작성 가이드
                        </h6>
                        <ul class="small text-muted mb-0">
                            <li>신선한 식재료의 경우 수령 가능한 날짜와 시간을 명시해주세요.</li>
                            <li>목표 인원은 실제 구매 가능한 인원으로 설정해주세요.</li>
                            <li>배송 방법을 명확히 하여 참여자들의 혼란을 방지하세요.</li>
                            <li>상품의 상태, 브랜드, 원산지 등을 자세히 작성하면 참여율이 높아집니다.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer Fragment -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Recipe-based Group Buy Script -->
    <script th:if="${recipe != null}">
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('groupBuyForm');
            const addIngredientBtn = document.getElementById('addIngredientBtn');
            const ingredientsList = document.getElementById('ingredientsList');
            const selectedIngredientsInput = document.getElementById('selectedIngredientsJson');
            let ingredientIndex = [[${recipe.ingredients.size()}]];
            
            if (!form || !selectedIngredientsInput) {
                console.error('필수 요소를 찾을 수 없습니다.');
                return;
            }
            
            // 폼 제출 시 선택된 재료를 JSON으로 변환
            form.addEventListener('submit', function(e) {
                const selectedIngredients = [];
                const checkboxes = document.querySelectorAll('.ingredient-checkbox');
                
                checkboxes.forEach((checkbox, index) => {
                    if (checkbox.checked) {
                        const measureInput = document.getElementById('measure-' + index) || 
                                           checkbox.closest('.ingredient-item').querySelector('.ingredient-measure');
                        selectedIngredients.push({
                            name: checkbox.dataset.name,
                            measure: measureInput ? measureInput.value : ''
                        });
                    }
                });
                
                if (selectedIngredients.length === 0) {
                    e.preventDefault();
                    alert('최소 1개 이상의 재료를 선택해주세요.');
                    return false;
                }
                
                selectedIngredientsInput.value = JSON.stringify(selectedIngredients);
            });
            
            // 재료 추가 버튼
            addIngredientBtn.addEventListener('click', function() {
                const newIngredient = document.createElement('div');
                newIngredient.className = 'col-md-6';
                newIngredient.innerHTML = `
                    <div class="border rounded p-3 ingredient-item">
                        <div class="form-check mb-2">
                            <input class="form-check-input ingredient-checkbox" 
                                   type="checkbox" 
                                   id="ingredient-${ingredientIndex}"
                                   data-name=""
                                   checked>
                            <label class="form-check-label" for="ingredient-${ingredientIndex}">
                                <input type="text" 
                                       class="form-control form-control-sm d-inline-block ingredient-name-input" 
                                       placeholder="재료명"
                                       required
                                       style="width: auto;">
                            </label>
                        </div>
                        <input type="text" 
                               class="form-control form-control-sm ingredient-measure" 
                               id="measure-${ingredientIndex}"
                               placeholder="분량 (예: 200g, 2개)">
                        <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-ingredient">
                            <i class="bi bi-trash"></i> 제거
                        </button>
                    </div>
                `;
                
                ingredientsList.appendChild(newIngredient);
                
                // 재료명 입력 시 data-name 업데이트
                const nameInput = newIngredient.querySelector('.ingredient-name-input');
                const checkbox = newIngredient.querySelector('.ingredient-checkbox');
                nameInput.addEventListener('input', function() {
                    checkbox.dataset.name = this.value;
                });
                
                // 제거 버튼 이벤트 리스너
                newIngredient.querySelector('.remove-ingredient').addEventListener('click', function() {
                    newIngredient.remove();
                });
                
                ingredientIndex++;
            });
        });
    </script>
</body>
</html>
