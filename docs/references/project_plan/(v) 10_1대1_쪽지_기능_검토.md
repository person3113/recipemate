# 1:1 ìª½ì§€ ê¸°ëŠ¥ êµ¬í˜„ ê²€í†  ê²°ê³¼

## ğŸ“‹ ê²€í†  ìš”ì•½

**ê²°ë¡ **: ì²¨ë¶€ëœ ê°€ì´ë“œë¼ì¸(`direct_message_guidelines.txt`)ì€ **ì „ë°˜ì ìœ¼ë¡œ ìš°ë¦¬ ì½”ë“œë² ì´ìŠ¤ì— ì˜ ë§ìŠµë‹ˆë‹¤**. ë‹¤ë§Œ ëª‡ ê°€ì§€ ìˆ˜ì • ë° ë³´ì™„ì´ í•„ìš”í•©ë‹ˆë‹¤.

---

## âœ… ì˜ ë§ëŠ” ë¶€ë¶„

### 1. íŒ¨í‚¤ì§€ êµ¬ì¡°
- âœ… `directmessage` íŒ¨í‚¤ì§€ ìƒì„± ë° 5ê°œ í•˜ìœ„ íŒ¨í‚¤ì§€ êµ¬ì¡°
  - `controller`, `dto`, `entity`, `repository`, `service`
  - ê¸°ì¡´ ë„ë©”ì¸ë“¤(`comment`, `groupbuy`, `notification` ë“±)ê³¼ ë™ì¼í•œ êµ¬ì¡°
  - **ì™„ë²½í•˜ê²Œ ì¼ì¹˜í•©ë‹ˆë‹¤**

### 2. ì—”í‹°í‹° ì„¤ê³„ íŒ¨í„´
- âœ… `BaseEntity` ìƒì†
  - í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš© ì¤‘ì¸ `BaseEntity`ê°€ `createdAt`, `updatedAt`, `deletedAt` ìë™ ê´€ë¦¬
  - **ì •í™•íˆ ë§ìŠµë‹ˆë‹¤**

- âœ… `@ManyToOne` ê´€ê³„ ì„¤ì •
  - `Comment` ì—”í‹°í‹°ê°€ `author`ë¥¼ `User`ì™€ ì—°ê²°í•˜ëŠ” íŒ¨í„´ê³¼ ë™ì¼
  - `sender`, `receiver` ëª¨ë‘ `User`ì™€ `@ManyToOne` ê´€ê³„
  - **íŒ¨í„´ì´ ì¼ì¹˜í•©ë‹ˆë‹¤**

- âœ… Lombok ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©
  - `@SuperBuilder`, `@NoArgsConstructor(access = AccessLevel.PROTECTED)`, `@AllArgsConstructor(access = AccessLevel.PRIVATE)`
  - í”„ë¡œì íŠ¸ì˜ ì¼ê´€ëœ ìŠ¤íƒ€ì¼
  - **ì™„ë²½í•˜ê²Œ ì¼ì¹˜í•©ë‹ˆë‹¤**

### 3. ë„¤ì´ë° ì»¨ë²¤ì…˜
- âœ… í…Œì´ë¸”ëª…: `direct_messages` (ë³µìˆ˜í˜•)
- âœ… ì™¸ë˜í‚¤ëª…: `fk_dm_sender`, `fk_dm_receiver` (ëª…í™•í•œ ëª…ëª…)
- âœ… í•„ë“œëª…: ì¹´ë©œì¼€ì´ìŠ¤ (`isRead`, `content`)
- **í”„ë¡œì íŠ¸ ì»¨ë²¤ì…˜ê³¼ ì¼ì¹˜í•©ë‹ˆë‹¤**

---

## âš ï¸ ìˆ˜ì • ë° ë³´ì™„ì´ í•„ìš”í•œ ë¶€ë¶„

### 1. ì—”í‹°í‹° í´ë˜ìŠ¤ ìˆ˜ì •ì‚¬í•­

#### 1-1. ì¸ë±ìŠ¤ ì¶”ê°€ ê¶Œì¥ â­ì¤‘ìš”â­
í”„ë¡œì íŠ¸ì˜ ë‹¤ë¥¸ ì—”í‹°í‹°ë“¤(`Comment`, `Notification`)ì€ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì¸ë±ìŠ¤ë¥¼ ì ê·¹ í™œìš©í•©ë‹ˆë‹¤.

**ê°€ì´ë“œë¼ì¸:**
```java
@Table(name = "direct_messages")
```

**ê¶Œì¥ ìˆ˜ì •:**
```java
@Entity
@Table(name = "direct_messages",
    indexes = {
        @Index(name = "idx_dm_sender_created", columnList = "sender_id, created_at"),
        @Index(name = "idx_dm_receiver_created", columnList = "receiver_id, created_at"),
        @Index(name = "idx_dm_receiver_is_read", columnList = "receiver_id, is_read, created_at")
    }
)
```

**ì´ìœ :**
- ë‘ ì‚¬ìš©ì ê°„ ëŒ€í™” ì¡°íšŒ ì‹œ `sender_id`, `receiver_id`ë¡œ ê²€ìƒ‰
- ì•ˆ ì½ì€ ë©”ì‹œì§€ ì¡°íšŒ ì‹œ `receiver_id` + `is_read` ì¡°í•© ê²€ìƒ‰
- ì‹œê°„ìˆœ ì •ë ¬ì„ ìœ„í•œ `created_at` í¬í•¨

#### 1-2. ì •ì  íŒ©í† ë¦¬ ë©”ì„œë“œ ì¶”ê°€ ê¶Œì¥ â­ì¤‘ìš”â­
í”„ë¡œì íŠ¸ì˜ ë‹¤ë¥¸ ì—”í‹°í‹°ë“¤(`Participation`, `Notification`)ì€ ìƒì„± ë¡œì§ì„ ì •ì  íŒ©í† ë¦¬ ë©”ì„œë“œë¡œ ìº¡ìŠí™”í•©ë‹ˆë‹¤.

**ê¶Œì¥ ì¶”ê°€:**
```java
public static DirectMessage create(User sender, User receiver, String content) {
    validateCreateArgs(sender, receiver, content);
    
    return DirectMessage.builder()
        .sender(sender)
        .receiver(receiver)
        .content(content)
        .isRead(false)
        .build();
}

private static void validateCreateArgs(User sender, User receiver, String content) {
    if (sender == null || receiver == null) {
        throw new CustomException(ErrorCode.INVALID_INPUT);
    }
    if (sender.getId().equals(receiver.getId())) {
        throw new CustomException(ErrorCode.CANNOT_SEND_MESSAGE_TO_SELF);
    }
    if (content == null || content.trim().isEmpty()) {
        throw new CustomException(ErrorCode.EMPTY_CONTENT);
    }
    if (content.length() > 1000) {
        throw new CustomException(ErrorCode.CONTENT_TOO_LONG);
    }
}
```

#### 1-3. ì½ìŒ ì²˜ë¦¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì¶”ê°€
`Notification` ì—”í‹°í‹°ì²˜ëŸ¼ ì½ìŒ ì²˜ë¦¬ ë©”ì„œë“œ ì¶”ê°€:

```java
public void markAsRead() {
    this.isRead = true;
}
```

---

### 2. Repository ìˆ˜ì •ì‚¬í•­ â­ì¤‘ìš”â­

#### 2-1. ì¿¼ë¦¬ ë©”ì„œë“œ ê°œì„ 
ê°€ì´ë“œë¼ì¸ì˜ ë©”ì„œë“œëª…ì´ ë„ˆë¬´ ê¸¸ê³  íŒŒë¼ë¯¸í„°ê°€ ì¤‘ë³µë©ë‹ˆë‹¤.

**ê°€ì´ë“œë¼ì¸:**
```java
List<DirectMessage> findBySenderAndReceiverOrReceiverAndSenderOrderByCreatedAtAsc(
    User sender, User receiver, User receiver2, User sender2);
```

**ê¶Œì¥ ê°œì„  (JPQL ì‚¬ìš©):**
```java
@Query("SELECT dm FROM DirectMessage dm WHERE " +
       "(dm.sender = :user1 AND dm.receiver = :user2) OR " +
       "(dm.sender = :user2 AND dm.receiver = :user1) " +
       "ORDER BY dm.createdAt ASC")
List<DirectMessage> findConversationBetween(
    @Param("user1") User user1, 
    @Param("user2") User user2
);
```

**ì¶”ê°€ ê¶Œì¥ ë©”ì„œë“œ:**
```java
// ì•ˆ ì½ì€ ë©”ì‹œì§€ ê°œìˆ˜ ì¡°íšŒ (ì•Œë¦¼ ë°°ì§€ìš©)
@Query("SELECT COUNT(dm) FROM DirectMessage dm WHERE dm.receiver = :receiver AND dm.isRead = false")
long countUnreadMessages(@Param("receiver") User receiver);

// ìˆ˜ì‹ ìì˜ ì•ˆ ì½ì€ ë©”ì‹œì§€ ì¼ê´„ ì½ìŒ ì²˜ë¦¬
@Modifying
@Query("UPDATE DirectMessage dm SET dm.isRead = true WHERE dm.receiver = :receiver AND dm.sender = :sender AND dm.isRead = false")
int markAllAsReadBetween(@Param("receiver") User receiver, @Param("sender") User sender);

// ìµœê·¼ ëŒ€í™” ìƒëŒ€ ëª©ë¡ ì¡°íšŒ (ë°›ì€í¸ì§€í•¨/ë³´ë‚¸í¸ì§€í•¨ìš©)
@Query("SELECT DISTINCT CASE WHEN dm.sender = :user THEN dm.receiver ELSE dm.sender END " +
       "FROM DirectMessage dm WHERE dm.sender = :user OR dm.receiver = :user " +
       "ORDER BY dm.createdAt DESC")
List<User> findRecentContacts(@Param("user") User user);
```

---

### 3. URL ë° Controller ì—”ë“œí¬ì¸íŠ¸ â­ì¤‘ìš”â­

#### 3-1. URL ì„¤ê³„ ìˆ˜ì • ê¶Œì¥
í”„ë¡œì íŠ¸ì˜ URL ì»¨ë²¤ì…˜ì„ ë³´ë©´ **ì¼€ë°¥ì¼€ì´ìŠ¤**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:
- `/group-purchases` (ê³µêµ¬)
- `/community-posts` (ì»¤ë®¤ë‹ˆí‹°)

**ê°€ì´ë“œë¼ì¸:**
```java
@RequestMapping("/messages")
GET /messages/{recipientId}
POST /messages/{recipientId}
```

**ê¶Œì¥ ìˆ˜ì •:**
```java
@RequestMapping("/direct-messages")

GET  /direct-messages/conversation/{userId}     // íŠ¹ì • ì‚¬ìš©ìì™€ì˜ ëŒ€í™” ì¡°íšŒ
POST /direct-messages/send/{recipientId}        // ìª½ì§€ ì „ì†¡
GET  /direct-messages/contacts                  // ìµœê·¼ ëŒ€í™” ìƒëŒ€ ëª©ë¡
GET  /direct-messages/unread-count              // ì•ˆ ì½ì€ ë©”ì‹œì§€ ê°œìˆ˜
POST /direct-messages/mark-as-read/{senderId}   // íŠ¹ì • ë°œì‹ ì ë©”ì‹œì§€ ì¼ê´„ ì½ìŒ ì²˜ë¦¬
```

---

### 4. í”„ë¡ íŠ¸ì—”ë“œ (View) ìˆ˜ì •ì‚¬í•­ â­ì¤‘ìš”â­

#### 4-1. participants.html ìˆ˜ì •
**ê°€ì´ë“œë¼ì¸:**
```html
<a th:href="@{/messages/{userId}(userId=${participant.user.id})}" 
   class="btn btn-sm btn-outline-primary">1:1 ìª½ì§€</a>
```

**ë¬¸ì œì :**
- `participant.user.id` ê²½ë¡œê°€ ì˜ëª»ë¨
- ì‹¤ì œ ê°ì²´ëŠ” `ParticipantResponse`ì´ë©°, ì§ì ‘ `userId` í•„ë“œë¥¼ ê°€ì§€ê³  ìˆìŒ

**ì˜¬ë°”ë¥¸ ì½”ë“œ:**
```html
<a th:href="@{/direct-messages/conversation/{userId}(userId=${participant.userId})}" 
   class="btn btn-sm btn-outline-primary">
    <i class="bi bi-envelope"></i> 1:1 ìª½ì§€
</a>
```

**í˜„ì¬ participants.html ìˆ˜ì • í•„ìš”:**
- 130ë²ˆì§¸ ì¤„ ë¶€ê·¼ì˜ ë¹„í™œì„±í™”ëœ ë²„íŠ¼ì„ ìœ„ ì½”ë“œë¡œ êµì²´
- `disabled` ì†ì„± ì œê±° ë° ì‹¤ì œ ë§í¬ ì—°ê²°

#### 4-2. conversation.html ìƒì„± ìœ„ì¹˜
**ê°€ì´ë“œë¼ì¸:**
```
src/main/resources/templates/directmessage/conversation.html
```

**ê¶Œì¥ ìˆ˜ì • (ì¼€ë°¥ì¼€ì´ìŠ¤ ì¼ê´€ì„±):**
```
src/main/resources/templates/direct-messages/conversation.html
```

---

### 5. Service ë° DTO êµ¬í˜„ ê°€ì´ë“œ

#### 5-1. DirectMessageService
```java
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class DirectMessageService {
    private final DirectMessageRepository directMessageRepository;
    private final UserRepository userRepository;
    private final NotificationService notificationService;

    @Transactional
    public DirectMessageResponse sendMessage(Long senderId, Long recipientId, String content) {
        User sender = userRepository.findById(senderId)
            .orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND));
        User recipient = userRepository.findById(recipientId)
            .orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND));

        DirectMessage message = DirectMessage.create(sender, recipient, content);
        DirectMessage saved = directMessageRepository.save(message);

        // ìˆ˜ì‹ ìì—ê²Œ ì•Œë¦¼ ì „ì†¡
        notificationService.createNotification(
            recipient,
            sender,
            sender.getNickname() + "ë‹˜ì´ ìª½ì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.",
            NotificationType.DIRECT_MESSAGE,
            "/direct-messages/conversation/" + sender.getId(),
            saved.getId(),
            EntityType.DIRECT_MESSAGE
        );

        return DirectMessageResponse.from(saved);
    }

    public List<DirectMessageResponse> getConversation(Long currentUserId, Long otherUserId) {
        User currentUser = userRepository.findById(currentUserId)
            .orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND));
        User otherUser = userRepository.findById(otherUserId)
            .orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND));

        List<DirectMessage> messages = directMessageRepository
            .findConversationBetween(currentUser, otherUser);

        return messages.stream()
            .map(DirectMessageResponse::from)
            .collect(Collectors.toList());
    }

    @Transactional
    public void markAsRead(Long receiverId, Long senderId) {
        User receiver = userRepository.findById(receiverId)
            .orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND));
        User sender = userRepository.findById(senderId)
            .orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND));

        directMessageRepository.markAllAsReadBetween(receiver, sender);
    }

    public long getUnreadCount(Long userId) {
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND));
        return directMessageRepository.countUnreadMessages(user);
    }
}
```

#### 5-2. DirectMessageResponse DTO
```java
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
@Builder
public class DirectMessageResponse {
    private Long id;
    private Long senderId;
    private String senderNickname;
    private Long receiverId;
    private String receiverNickname;
    private String content;
    private boolean isRead;
    private LocalDateTime createdAt;

    public static DirectMessageResponse from(DirectMessage message) {
        return DirectMessageResponse.builder()
            .id(message.getId())
            .senderId(message.getSender().getId())
            .senderNickname(message.getSender().getNickname())
            .receiverId(message.getReceiver().getId())
            .receiverNickname(message.getReceiver().getNickname())
            .content(message.getContent())
            .isRead(message.isRead())
            .createdAt(message.getCreatedAt())
            .build();
    }
}
```

#### 5-3. SendMessageRequest DTO
```java
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
public class SendMessageRequest {
    @NotBlank(message = "ë©”ì‹œì§€ ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(max = 1000, message = "ë©”ì‹œì§€ëŠ” ìµœëŒ€ 1000ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤")
    private String content;
}
```

---

### 6. ì¶”ê°€ ê³ ë ¤ì‚¬í•­

#### 6-1. NotificationType Enum í™•ì¥
`global/common/NotificationType.java`ì— ì¶”ê°€:
```java
DIRECT_MESSAGE("ìª½ì§€"),
```

#### 6-2. EntityType Enum í™•ì¥
`global/common/EntityType.java`ì— ì¶”ê°€:
```java
DIRECT_MESSAGE,
```

#### 6-3. ErrorCode Enum í™•ì¥
`global/exception/ErrorCode.java`ì— ì¶”ê°€:
```java
CANNOT_SEND_MESSAGE_TO_SELF(HttpStatus.BAD_REQUEST, "ìì‹ ì—ê²ŒëŠ” ìª½ì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),
EMPTY_CONTENT(HttpStatus.BAD_REQUEST, "ë©”ì‹œì§€ ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤"),
CONTENT_TOO_LONG(HttpStatus.BAD_REQUEST, "ë©”ì‹œì§€ëŠ” ìµœëŒ€ 1000ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤"),
```

#### 6-4. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
- í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ìª½ì§€ ì¡°íšŒ ê°€ëŠ¥í•˜ë„ë¡ ê¶Œí•œ ì²´í¬
- íƒ€ì¸ì˜ ìª½ì§€ ëŒ€í™” ë‚´ìš© ì¡°íšŒ ì‹œë„ ì‹œ 403 Forbidden ì‘ë‹µ
- Controllerì—ì„œ `@AuthenticationPrincipal` í™œìš©

```java
@GetMapping("/conversation/{userId}")
public String getConversation(
    @PathVariable Long userId,
    @AuthenticationPrincipal CustomUserDetails userDetails,
    Model model
) {
    // ë³¸ì¸ì´ ì°¸ì—¬í•œ ëŒ€í™”ë§Œ ì¡°íšŒ ê°€ëŠ¥
    // ...
}
```

---

## ğŸ“ êµ¬í˜„ ìˆœì„œ ê¶Œì¥

1. **ë°±ì—”ë“œ ê¸°ë³¸ êµ¬ì¡°**
   - `DirectMessage` ì—”í‹°í‹° ìƒì„± (ì¸ë±ìŠ¤, ì •ì  íŒ©í† ë¦¬ ë©”ì„œë“œ í¬í•¨)
   - `DirectMessageRepository` ìƒì„± (JPQL ì¿¼ë¦¬ í¬í•¨)
   - DTO í´ë˜ìŠ¤ë“¤ ìƒì„±

2. **ì„œë¹„ìŠ¤ ë ˆì´ì–´**
   - `DirectMessageService` êµ¬í˜„
   - NotificationType, EntityType, ErrorCode Enum í™•ì¥

3. **ì»¨íŠ¸ë¡¤ëŸ¬**
   - `DirectMessageController` êµ¬í˜„
   - ê¶Œí•œ ê²€ì¦ ë¡œì§ ì¶”ê°€

4. **í”„ë¡ íŠ¸ì—”ë“œ**
   - `conversation.html` ìƒì„±
   - `participants.html` ìˆ˜ì • (ë²„íŠ¼ í™œì„±í™”)
   - í—¤ë”ì— ì•ˆ ì½ì€ ìª½ì§€ ê°œìˆ˜ ë°°ì§€ ì¶”ê°€ (ì„ íƒì‚¬í•­)

5. **í…ŒìŠ¤íŠ¸**
   - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
   - í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±
   - ì‹¤ì œ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

---

## ğŸ¯ ìµœì¢… ê²°ë¡ 

ê°€ì´ë“œë¼ì¸ì€ **ì „ë°˜ì ìœ¼ë¡œ ìš°ìˆ˜í•˜ë©° í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ì˜ ë§ìŠµë‹ˆë‹¤**.

### âœ… ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥:
- íŒ¨í‚¤ì§€ êµ¬ì¡° (`directmessage/controller/dto/entity/repository/service`)
- ì—”í‹°í‹° ì„¤ê³„ íŒ¨í„´ (BaseEntity ìƒì†, @ManyToOne ê´€ê³„)
- Lombok ì–´ë…¸í…Œì´ì…˜ ìŠ¤íƒ€ì¼
- í…Œì´ë¸”/í•„ë“œ ë„¤ì´ë°

### âš ï¸ ë°˜ë“œì‹œ ìˆ˜ì • í•„ìš”:
1. **ì¸ë±ìŠ¤ ì¶”ê°€** (ì„±ëŠ¥ ìµœì í™”)
2. **Repository ì¿¼ë¦¬ ë©”ì„œë“œ** (JPQL ì‚¬ìš©)
3. **URL ì¼€ë°¥ì¼€ì´ìŠ¤** (`/direct-messages`)
4. **View ê²½ë¡œ ìˆ˜ì •** (`participant.userId`)
5. **ì •ì  íŒ©í† ë¦¬ ë©”ì„œë“œ ì¶”ê°€** (ìœ íš¨ì„± ê²€ì¦)

ìœ„ ìˆ˜ì •ì‚¬í•­ì„ ë°˜ì˜í•˜ë©´ **í”„ë¡œì íŠ¸ì˜ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ë©´ì„œ ì•ˆì •ì ì¸ ìª½ì§€ ê¸°ëŠ¥ì„ êµ¬í˜„**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€

