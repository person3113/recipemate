# SQL 쿼리 성능 분석 보고서

각 페이지에 대한 SQL 쿼리 로그를 분석하여 N+1 문제 및 잠재적인 성능 병목 현상을 점검합니다.

## 전체 요약

- **N+1 문제**: 댓글을 표시하는 상세 페이지(`공구 상세`, `커뮤니티 게시글 상세`)에서 심각한 N+1 문제가 발견되었습니다. 댓글 목록 조회 후, 각 댓글에 대한 추가 정보(대댓글, 작성자, 좋아요 수)를 개별적으로 조회하여 쿼리가 과도하게 발생합니다.
- **1+1 문제 (개선 가능)**: 여러 목록 페이지(`공구 목록`, `커뮤니티 목록`, `검색 결과`)에서 1개의 목록 조회 쿼리 후, 목록에 포함된 아이템들의 이미지를 가져오기 위해 `IN` 절을 사용한 1개의 추가 쿼리가 실행됩니다. 이는 일반적인 최적화 기법(배치 조회)이지만, `JOIN FETCH`를 사용하면 단일 쿼리로 최적화할 수 있습니다.

---

## 페이지별 상세 분석

### 1. 레시피 목록 (`/recipes`)

- **쿼리**: 레시피 목록(페이지네이션)과 전체 카운트를 가져오는 2개의 쿼리가 실행됩니다.
- **분석**: 특이사항 없음. 표준적인 페이지네이션 구현입니다.

### 2. 공구 목록 (`/group-purchases/list`)

- **쿼리**:
    1. 공구 목록 조회 (페이지네이션, 작성자 정보 `JOIN`, 리뷰 평점/개수 `Subquery`)
    2. 공구 이미지 목록 조회 (`WHERE group_buy_id IN (...)`)
- **분석**:
    - **1+1 문제**: 공구 목록 조회 후, 해당 목록에 포함된 모든 공구의 이미지를 한 번의 추가 쿼리로 가져옵니다. `JOIN FETCH`를 사용하면 한 번의 쿼리로 해결 가능합니다.

### 3. 커뮤니티 목록 (`/community-posts/list`)

- **쿼리**:
    1. 게시글 목록 조회 (페이지네이션, 작성자 정보 `JOIN`, 좋아요/댓글 수 `Subquery`)
    2. 게시글 이미지 목록 조회 (`WHERE post_id IN (...)`)
- **분석**:
    - **1+1 문제**: 공구 목록과 마찬가지로, 게시글 목록 조회 후 이미지를 가져오기 위한 추가 쿼리가 발생합니다.
    - 각 게시글의 좋아요 및 댓글 수를 서브쿼리로 가져오는 방식은 데이터가 많아질 경우 성능 저하의 원인이 될 수 있습니다.

### 4. 커뮤니티 게시글 상세 (`/community-posts/{id}`)

- **쿼리**:
    1. 게시글 정보 조회 (작성자 `JOIN`)
    2. 게시글 이미지, 좋아요 수, 댓글 수 등 추가 정보 조회
    3. 댓글 목록 조회 (페이지네이션)
    4. **(N+1)** 각 댓글의 작성자 정보 조회 (`SELECT ... FROM users WHERE id = ?`)
    5. **(N+1)** 각 댓글의 좋아요 수 조회 (`SELECT count(...) FROM comment_likes WHERE comment_id = ?`)
    6. **(N+1)** 각 댓글에 대한 현재 사용자의 좋아요 여부 조회
    7. **(N+1)** 각 부모 댓글의 대댓글 목록 조회 (`SELECT ... FROM comments WHERE parent_id = ?`)
- **분석**:
    - **심각한 N+1 문제**: 댓글 목록을 가져온 후, 각 댓글마다 작성자, 좋아요 수, 대댓글 등을 가져오기 위해 루프를 돌며 추가 쿼리를 실행합니다. 댓글이 10개이고 각 댓글에 대댓글이 5개 있다면 수십~수백 개의 쿼리가 발생할 수 있습니다.
    - **해결 방안**:
        - 댓글과 작성자 정보를 `JOIN FETCH`로 함께 조회합니다.
        - 댓글 목록에 필요한 추가 정보(좋아요 수, 대댓글 수 등)는 DTO 프로젝션을 사용하여 한 번의 쿼리로 가져오도록 최적화합니다.

### 5. 공구 상세 (`/group-purchases/{id}`)

- **분석**: `커뮤니티 게시글 상세` 페이지와 동일하게 댓글 관련 로직에서 **심각한 N+1 문제**가 발생합니다. 해결 방안도 동일합니다.

### 6. 레시피 상세 (`/recipes/{api-id}`)

- **쿼리**:
    1. 레시피 정보와 재료 정보 조회 (`LEFT JOIN recipe_ingredients`)
    2. 레시피 단계별 설명 조회
    3. 연관된 공구 목록 조회 (중복 호출로 추정)
- **분석**:
    - `recipe_ingredients`를 `JOIN`으로 가져올 때, 레시피 정보가 재료 수만큼 중복될 수 있습니다. JPA에서는 `Set`으로 받거나 `distinct`를 사용하여 해결할 수 있습니다.
    - 연관된 공구 목록을 조회하는 동일한 쿼리가 두 번 실행됩니다. 코드 로직 확인이 필요합니다.

### 7. 마이페이지 (`/users/me` 및 하위 탭)

- **쿼리**:
    - `/users/me`: 내 정보, 뱃지, 주최/참여 공구 수, 리뷰 수 등 다수의 `COUNT` 쿼리가 실행됩니다.
    - `/users/me/community`: 내가 쓴 게시글 목록을 가져오며, 각 게시글의 댓글/좋아요 수를 서브쿼리로 조회합니다.
- **분석**:
    - 마이페이지 첫 화면의 다수 `COUNT` 쿼리는 한 번에 집계하는 쿼리로 최적화할 수 있으나, 사용자 본인에게만 해당되므로 성능 영향은 제한적일 수 있습니다.
    - `내가 쓴 게시글` 탭의 서브쿼리 문제는 `커뮤니티 목록` 페이지와 동일한 잠재적 성능 문제를 가집니다.

### 8. 통합 검색 (`/search?keyword=...`)

- **쿼리**:
    1. 검색 키워드 저장/업데이트
    2. 공구 검색 결과 + 이미지 조회 (1+1 문제)
    3. 게시글 검색 결과 (제목, 내용, 댓글 내용까지 포함하는 복잡한 쿼리)
    4. 레시피 검색 결과
- **분석**:
    - 검색 결과 중 공구 목록은 `공구 목록` 페이지와 동일한 **1+1 문제**를 가집니다.

---

## 권장 개선 사항

1.  **[긴급] 댓글 조회 로직 개선**: `공구 상세`, `커뮤니티 게시글 상세` 페이지의 댓글 N+1 문제를 `JOIN FETCH`와 DTO 프로젝션을 사용하여 해결합니다.
2.  **[권장] 목록 페이지 1+1 문제 개선**: `공구 목록`, `커뮤니티 목록` 등에서 발생하는 이미지 조회 1+1 문제를 `JOIN FETCH`를 적용하여 단일 쿼리로 최적화합니다.
