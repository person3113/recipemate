# 1:1 쪽지 기능 사용 가이드

## ✅ 현재 상태

쪽지 전송 및 대화 조회 기능이 **완전히 작동합니다!**

단, 알림 기능은 임시로 비활성화되어 있습니다.

---

## 🎯 사용 방법

### 1. 애플리케이션 재시작

현재 실행 중인 애플리케이션을 중지하고 다시 시작하세요:

```bash
cd C:\Users\wnstj\opensw_recipemate_web\recipemate
.\gradlew.bat bootRun
```

### 2. 쪽지 보내기

**방법 1: 참여자 관리 페이지에서**
1. 공구 주최자로 로그인
2. **"참여자 관리"** 페이지 이동
3. 각 참여자 옆의 **"쪽지"** 버튼 클릭
4. 메시지 입력 후 **"전송"** 버튼 클릭

**방법 2: 마이페이지에서**
1. 로그인 후 **"마이페이지"** 이동
2. 왼쪽 바로가기 메뉴에서 **"쪽지함"** 클릭
3. 대화 상대 목록에서 선택하여 메시지 전송

### 3. 대화 목록 확인

**접근 방법:**
- **마이페이지**: 바로가기 메뉴의 "쪽지함" 클릭
  - 안 읽은 메시지가 있으면 빨간 배지로 개수 표시
- **직접 URL**: `http://localhost:8080/direct-messages/contacts`
- 최근 대화한 상대 목록 표시
- 상대를 클릭하면 대화방으로 이동

---

## ⚠️ 알림 기능 활성화 방법

현재 알림 기능은 데이터베이스 제약조건 때문에 비활성화되어 있습니다.

### 🔍 왜 알림이 비활성화되었나?

H2 데이터베이스의 `notifications` 테이블에는 `related_entity_type` 컬럼에 들어갈 수 있는 값이 제한되어 있습니다:
```sql
-- 현재: 5가지만 허용
CHECK (related_entity_type IN ('GROUP_BUY', 'POST', 'COMMENT', 'REVIEW', 'RECIPE'))
```

하지만 쪽지 기능을 위해 `DIRECT_MESSAGE`라는 새로운 타입이 필요합니다. 
이 제약조건을 수정하지 않으면 쪽지 알림 생성 시 에러가 발생합니다.

### 방법 1: H2 콘솔에서 수정 ⭐추천⭐ (데이터 완전 유지)

**✅ 모든 데이터가 100% 유지됩니다!**
- 사용자 계정, 레시피, 공구, 댓글, 게시글 등 **모든 데이터 보존**
- **제약조건(규칙)만 수정**하여 `DIRECT_MESSAGE` 타입 허용
- 안전하고 빠른 방법 (약 1분 소요)

**실행 단계:**

1. **애플리케이션 실행 중** 브라우저에서 접속:
   ```
   http://localhost:8080/h2-console
   ```

2. 연결 정보 입력:
   - **JDBC URL**: `jdbc:h2:file:./data/recipemate`
   - **User Name**: `sa`
   - **Password**: (공백)

3. 접속 후 아래 SQL 순서대로 실행:

   ```sql
   -- 1단계: 기존 제약조건 이름 확인 (조회만 하므로 데이터에 영향 없음)
   SELECT CONSTRAINT_NAME FROM INFORMATION_SCHEMA.CONSTRAINTS 
   WHERE TABLE_NAME = 'NOTIFICATIONS' 
   AND COLUMN_LIST LIKE '%RELATED_ENTITY_TYPE%';
   -- 결과 예시: CONSTRAINT_8D (이 이름을 다음 단계에서 사용)
   
   -- 2단계: 낡은 제약조건 삭제 (제약조건만 제거, 데이터는 그대로 유지)
   ALTER TABLE NOTIFICATIONS DROP CONSTRAINT CONSTRAINT_8D;
   -- ↑ 실행 결과: "이 컬럼에는 이제 아무 값이나 들어갈 수 있어"
   
   -- 3단계: 새로운 제약조건 추가 (DIRECT_MESSAGE 포함, 데이터 무관)
   ALTER TABLE NOTIFICATIONS 
   ADD CONSTRAINT check_entity_type 
   CHECK (RELATED_ENTITY_TYPE IN ('GROUP_BUY', 'POST', 'COMMENT', 'REVIEW', 'RECIPE', 'DIRECT_MESSAGE'));
   -- ↑ 실행 결과: "이제 DIRECT_MESSAGE도 허용돼!"
   ```

   **⚠️ 중요:**
   - 위 SQL은 **테이블 구조(스키마)만 수정**합니다
   - **기존 데이터(사용자, 레시피, 공구 등)는 전혀 건드리지 않습니다**
   - 마치 "출입 가능한 명단"만 업데이트하는 것과 같습니다

4. `DirectMessageService.java` 파일에서 주석 해제:
   ```java
   // 45~55번째 줄의 주석을 제거하고 활성화
   notificationService.createNotification(
       recipientId,
       NotificationType.DIRECT_MESSAGE,
       senderId,
       senderId,
       EntityType.DIRECT_MESSAGE
   );
   ```

5. 애플리케이션 재시작

### 방법 2: 데이터베이스 초기화 (모든 데이터 삭제)

**⚠️ 주의: 사용자, 레시피, 공구 등 모든 데이터가 삭제됩니다!**

1. 애플리케이션 중지

2. 데이터베이스 파일 삭제:
   ```bash
   cd C:\Users\wnstj\opensw_recipemate_web\recipemate\data
   del recipemate.mv.db
   del recipemate.trace.db
   ```

3. `DirectMessageService.java` 파일에서 주석 해제

4. 애플리케이션 재시작 → 데이터베이스 자동 재생성 (DIRECT_MESSAGE 포함)

---

## 📝 현재 작동하는 기능

### ✅ 완전 작동
- 쪽지 전송
- 대화 내용 조회
- 대화 목록 확인
- 읽음 처리
- 안 읽은 메시지 개수 조회
- **마이페이지 쪽지함 바로가기** (안 읽은 메시지 배지 표시)

### ⏸️ 임시 비활성화
- 쪽지 수신 시 알림 생성 (위 방법으로 활성화 가능)

---

## 🧪 테스트 시나리오

1. **사용자 A**: 공구 생성 및 참여자 추가
2. **사용자 A**: 참여자 관리 페이지에서 참여자 B에게 쪽지 전송
3. **사용자 B**: 로그인 후 `/direct-messages/contacts` 접속
4. **사용자 B**: 사용자 A와의 대화방 확인 및 답장

---

## 🔧 문제 해결

### 500 에러 발생 시
- 알림 기능이 활성화된 상태라면 위의 "방법 1"을 따라 제약조건 수정

### 대화 목록이 비어있을 때
- 정상입니다. 아직 아무에게도 쪽지를 보내지 않은 상태입니다.
- 참여자 관리 페이지에서 쪽지를 보내면 목록에 표시됩니다.

### 메시지가 전송되지 않을 때
- 브라우저 콘솔(F12) 확인
- 서버 로그 확인
- `DirectMessageService.java`의 주석 처리된 알림 코드가 활성화되어 있는지 확인

---

## 📌 요약

**현재 상태**: 쪽지 기능 100% 작동 (알림 제외)

**데이터 보존**: 사용자 및 레시피 데이터는 그대로 유지됨

**알림 활성화**: H2 콘솔에서 제약조건 수정 필요 (선택사항)

**권장 사용법**: 당장은 알림 없이 쪽지만 사용하고, 필요 시 나중에 H2 콘솔에서 제약조건 수정

