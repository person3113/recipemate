<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::main-content}, ~{::additional-head}, ~{::additional-scripts})}">
<head>
    <th:block th:fragment="title">참여자 관리 - RecipeMate</th:block>
    <th:block th:fragment="additional-head"></th:block>
</head>
<body>
    <main th:fragment="main-content" class="container py-4">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <!-- 공구 정보 카드 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h1 class="h4 mb-2">
                                    <i class="bi bi-people-fill"></i> 참여자 관리
                                </h1>
                                <h5 class="text-muted mb-0" th:text="${groupBuy.title}">공구 제목</h5>
                            </div>
                            <div th:replace="~{fragments/back-button :: simple-button(url=@{/group-purchases/{id}(id=${groupBuy.id})}, text='공구로 돌아가기', cssClass='mb-3')}"></div>
                        </div>
                        
                        <!-- 공구 요약 정보 -->
                        <div class="row text-muted small">
                            <div class="col-md-4">
                                <i class="bi bi-people"></i> 
                                참여 현황: 
                                <span class="fw-bold text-primary" th:text="${groupBuy.currentHeadcount} + '/' + ${groupBuy.targetHeadcount} + '명'">0/10명</span>
                            </div>
                            <div class="col-md-4">
                                <i class="bi bi-tag"></i> 
                                상태: 
                                <span class="badge" 
                                      th:classappend="${groupBuy.status.name() == 'RECRUITING'} ? 'bg-info' : 
                                                      (${groupBuy.status.name() == 'IMMINENT'} ? 'bg-warning' : 
                                                      (${groupBuy.status.name() == 'CLOSED'} ? 'bg-secondary' : 
                                                      (${groupBuy.status.name() == 'COMPLETED'} ? 'bg-success' : 'bg-danger')))"
                                      th:text="${groupBuy.status.name() == 'RECRUITING'} ? '모집중' : 
                                               (${groupBuy.status.name() == 'IMMINENT'} ? '임박' : 
                                               (${groupBuy.status.name() == 'CLOSED'} ? '마감' : 
                                               (${groupBuy.status.name() == 'COMPLETED'} ? '완료' : '취소')))">
                                    상태
                                </span>
                            </div>
                            <div class="col-md-4">
                                <i class="bi bi-calendar"></i> 
                                마감일: <span th:text="${#temporals.format(groupBuy.deadline, 'yyyy-MM-dd')}">2024-01-01</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 참여자 목록 -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul"></i> 참여자 목록 
                            <span class="badge bg-primary" th:text="${participants.size()}">0</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- 참여자가 없는 경우 -->
                        <div th:if="${participants == null or participants.isEmpty()}" class="text-center py-5">
                            <i class="bi bi-person-x display-1 text-muted"></i>
                            <h5 class="mt-3">참여자가 없습니다</h5>
                            <p class="text-muted">아직 참여한 사용자가 없습니다.</p>
                        </div>
                        
                        <!-- 참여자 목록 테이블 -->
                        <div th:if="${participants != null and !participants.isEmpty()}" class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">닉네임</th>
                                        <th scope="col">매너온도</th>
                                        <th scope="col">참여일</th>
                                        <th scope="col">수령 방법</th>
                                        <th scope="col">수량</th>
                                        <th scope="col">배송지 정보</th>
                                        <th scope="col">액션</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="participant, iterStat : ${participants}">
                                        <td th:text="${iterStat.count}">1</td>
                                        <td>
                                            <strong th:text="${participant.nickname}">닉네임</strong>
                                        </td>
                                        <td>
                                            <span class="badge" 
                                                  th:classappend="${participant.mannerTemperature >= 40} ? 'bg-success' : (${participant.mannerTemperature >= 30} ? 'bg-primary' : 'bg-secondary')"
                                                  th:text="${#numbers.formatDecimal(participant.mannerTemperature, 1, 1)} + '°C'">
                                                36.5°C
                                            </span>
                                        </td>
                                        <td th:text="${#temporals.format(participant.participatedAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 12:00</td>
                                        <td>
                                            <span th:if="${participant.selectedDeliveryMethod.name() == 'DIRECT'}" class="badge bg-info">
                                                <i class="bi bi-person-arms-up"></i> 직거래
                                            </span>
                                            <span th:if="${participant.selectedDeliveryMethod.name() == 'PARCEL'}" class="badge bg-warning">
                                                <i class="bi bi-box-seam"></i> 택배
                                            </span>
                                        </td>
                                        <td>
                                            <span class="fw-bold" th:text="${participant.quantity} + '개'">1개</span>
                                        </td>
                                        <td>
                                            <!-- 택배 선택 시 배송지 정보 표시 -->
                                            <div th:if="${participant.selectedDeliveryMethod.name() == 'PARCEL' and participant.fullAddress != null}">
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-info" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#addressModal"
                                                        th:data-address-name="${participant.addressName}"
                                                        th:data-recipient-name="${participant.recipientName}"
                                                        th:data-recipient-phone="${participant.recipientPhoneNumber}"
                                                        th:data-full-address="${participant.fullAddress}"
                                                        title="배송지 정보 보기">
                                                    <i class="bi bi-geo-alt"></i> 배송지 확인
                                                </button>
                                            </div>
                                            <span th:if="${participant.selectedDeliveryMethod.name() == 'DIRECT'}" class="text-muted small">
                                                <i class="bi bi-dash"></i> 해당없음
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group" th:if="${participant.userId != currentUserId}">
                                                <!-- 1:1 쪽지 보내기 -->
                                                <a th:href="@{/direct-messages/conversation/{userId}(userId=${participant.userId})}"
                                                   class="btn btn-sm btn-outline-primary"
                                                   title="1:1 쪽지 보내기">
                                                    <i class="bi bi-envelope"></i> 쪽지
                                                </a>

                                                <!-- 강제 탈퇴 버튼 -->
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#removeModal"
                                                        th:data-user-id="${participant.userId}"
                                                        th:data-nickname="${participant.nickname}"
                                                        title="참여자를 강제 탈퇴시킵니다">
                                                    <i class="bi bi-person-x"></i> 탈퇴
                                                </button>
                                            </div>
                                            <span th:if="${participant.userId == currentUserId}" class="text-muted small">
                                                <i class="bi bi-person-check"></i> 본인
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 안내 메시지 -->
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>안내:</strong> 각 참여자와 1:1 쪽지를 주고받을 수 있습니다.
                </div>
            </div>
        </div>
        
        <!-- 배송지 정보 모달 -->
        <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addressModalLabel">
                            <i class="bi bi-geo-alt-fill text-primary"></i> 배송지 정보
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">주소 별칭</dt>
                            <dd class="col-sm-8" id="modalAddressName">-</dd>
                            
                            <dt class="col-sm-4">수령인</dt>
                            <dd class="col-sm-8" id="modalRecipientName">-</dd>
                            
                            <dt class="col-sm-4">연락처</dt>
                            <dd class="col-sm-8" id="modalRecipientPhone">-</dd>
                            
                            <dt class="col-sm-4">주소</dt>
                            <dd class="col-sm-8" id="modalFullAddress">-</dd>
                        </dl>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 강제 탈퇴 확인 모달 -->
        <div class="modal fade" id="removeModal" tabindex="-1" aria-labelledby="removeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="removeModalLabel">
                            <i class="bi bi-exclamation-triangle text-warning"></i> 참여자 강제 탈퇴
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-2">정말로 <strong id="targetNickname"></strong>님을 강제 탈퇴시키시겠습니까?</p>
                        <div class="alert alert-warning small mb-0">
                            <i class="bi bi-info-circle"></i>
                            이 작업은 되돌릴 수 없으며, 해당 참여자에게 알림이 전송됩니다.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <form id="removeForm" method="post" style="display: inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-person-x"></i> 탈퇴시키기
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <th:block th:fragment="additional-scripts">
        <!-- 배송지 정보 모달 JavaScript -->
        <script th:inline="javascript">
            const addressModal = document.getElementById('addressModal');
            const modalAddressName = document.getElementById('modalAddressName');
            const modalRecipientName = document.getElementById('modalRecipientName');
            const modalRecipientPhone = document.getElementById('modalRecipientPhone');
            const modalFullAddress = document.getElementById('modalFullAddress');
            
            addressModal.addEventListener('show.bs.modal', function (event) {
                // 버튼에서 데이터 가져오기
                const button = event.relatedTarget;
                const addressName = button.getAttribute('data-address-name');
                const recipientName = button.getAttribute('data-recipient-name');
                const recipientPhone = button.getAttribute('data-recipient-phone');
                const fullAddress = button.getAttribute('data-full-address');
                
                // 모달 내용 업데이트
                modalAddressName.textContent = addressName || '-';
                modalRecipientName.textContent = recipientName || '-';
                modalRecipientPhone.textContent = recipientPhone || '-';
                modalFullAddress.textContent = fullAddress || '-';
            });
        </script>
        
        <!-- 강제 탈퇴 모달 JavaScript -->
        <script th:inline="javascript">
            const removeModal = document.getElementById('removeModal');
            const removeForm = document.getElementById('removeForm');
            const targetNickname = document.getElementById('targetNickname');
            const groupBuyId = /*[[${groupBuy.id}]]*/ 0;
            
            removeModal.addEventListener('show.bs.modal', function (event) {
                // 버튼에서 데이터 가져오기
                const button = event.relatedTarget;
                const userId = button.getAttribute('data-user-id');
                const nickname = button.getAttribute('data-nickname');
                
                // 모달 내용 업데이트
                targetNickname.textContent = nickname;
                removeForm.action = `/group-purchases/${groupBuyId}/participants/${userId}/remove`;
            });
        </script>
    </th:block>
</body>
</html>
