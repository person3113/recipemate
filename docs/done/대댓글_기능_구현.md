# 게시글 대댓글(답글) 기능 구현

## 구현 날짜
2025년 1월 9일

## 브랜치
comment 브랜치 (mypage 브랜치에서 분기)

## 구현 내용

### 1. 백엔드 수정

#### 1.1 CommentController 업데이트
- **파일**: `src/main/java/com/recipemate/domain/comment/controller/CommentController.java`
- **변경사항**:
  - `createCommentFragment` 메서드에서 `parentId`가 있으면 `reply-item` Fragment 반환
  - `targetType`과 `targetId`를 모델에 추가하여 대댓글 폼에서 사용 가능하도록 수정

```java
// 대댓글이면 reply-item, 일반 댓글이면 comment-item Fragment 반환
if (parentId != null) {
    return "fragments/comments :: reply-item(comment=${comment}, targetType=${targetType}, targetId=${targetId})";
}
return "fragments/comments :: comment-item";
```

### 2. 프론트엔드 구현

#### 2.1 대댓글 아이템 Fragment 추가
- **파일**: `src/main/resources/templates/fragments/comments.html`
- **Fragment 이름**: `reply-item(comment, targetType, targetId)`
- **기능**:
  - 대댓글 전용 UI (화살표 아이콘 포함)
  - 삭제 버튼 (작성자만 표시)
  - htmx로 동적 삭제 지원

#### 2.2 대댓글 작성 폼 수정
- **필수 필드 추가**:
  - `targetType`: 게시글인지 공구인지 구분
  - `targetId`: 대상 게시글/공구 ID
  - `type`: 댓글 타입 (GENERAL)
  - `parentId`: 부모 댓글 ID

```html
<form th:action="@{/comments}" method="post"
      hx-post th:hx-post="@{/comments/fragment}"
      hx-target th:hx-target="'#replies-' + ${comment.id}"
      hx-swap="beforeend">
    <input type="hidden" name="targetType" th:value="${targetType}"/>
    <input type="hidden" name="targetId" th:value="${targetId}"/>
    <input type="hidden" name="type" value="GENERAL"/>
    <input type="hidden" name="parentId" th:value="${comment.id}"/>
    <!-- ... -->
</form>
```

#### 2.3 JavaScript 이벤트 핸들러 개선
- **htmx afterSwap 이벤트**:
  - 대댓글 추가 시 대댓글 컨테이너 표시
  - 대댓글 폼 자동 숨김 및 초기화
  - 댓글 작성 폼 초기화

```javascript
document.body.addEventListener('htmx:afterSwap', function(event) {
    // 답글 추가 후 처리
    if (event.detail.target.id && event.detail.target.id.startsWith('replies-')) {
        const repliesContainer = event.detail.target;
        // 컨테이너 보이기
        repliesContainer.classList.remove('d-none');
        repliesContainer.classList.add('border-top', 'bg-light');
        
        // 답글 폼 숨기기 및 초기화
        const commentId = repliesContainer.id.replace('replies-', '');
        const replyForm = document.getElementById('reply-form-' + commentId);
        if (replyForm) {
            replyForm.classList.add('d-none');
            const textarea = replyForm.querySelector('textarea');
            if (textarea) textarea.value = '';
        }
    }
});
```

## 사용 방법

### 대댓글 작성
1. 게시글 상세 페이지에서 댓글 확인
2. 댓글 하단의 "답글" 버튼 클릭
3. 답글 입력 폼에 내용 작성
4. "등록" 버튼 클릭
5. 페이지 새로고침 없이 즉시 대댓글 표시

### 대댓글 삭제
1. 본인이 작성한 대댓글의 휴지통 아이콘 클릭
2. 확인 대화상자에서 "확인" 클릭
3. 페이지 새로고침 없이 즉시 삭제

## 주요 특징

1. **htmx 사용**: 페이지 새로고침 없이 동적으로 대댓글 추가/삭제
2. **깊이 제한**: 대댓글의 대댓글은 불가능 (2단계 제한)
3. **실시간 UI 업데이트**: JavaScript로 폼 초기화 및 컨테이너 표시 관리
4. **권한 관리**: 작성자만 삭제 버튼 표시
5. **좋아요 기능 없음**: 순수 대댓글 기능만 구현 (다른 팀원이 좋아요 기능 구현)
6. **스마트 삭제**: 
   - 답글이 없는 댓글: 완전히 제거
   - 답글이 있는 댓글: "삭제된 댓글입니다" 메시지로 표시 (스레드 구조 유지)
   - 삭제된 댓글도 작성자 이름과 작성 시간 표시 (컨텍스트 제공)

## 데이터 흐름

### 대댓글 작성
```
사용자 입력
  ↓
htmx POST /comments/fragment
  - targetType, targetId, type, parentId 전송
  ↓
CommentController.createCommentFragment()
  - parentId 확인
  - 대댓글이면 reply-item Fragment 반환
  ↓
htmx가 #replies-{commentId}에 추가
  ↓
htmx afterSwap 이벤트
  - 컨테이너 표시
  - 폼 초기화
```

### 대댓글 삭제
```
사용자가 삭제 버튼 클릭
  ↓
JavaScript deleteReply() 함수 실행
  ↓
POST /comments/replies/{id}/delete
  ↓
CommentController.deleteComment()
  - 댓글 소프트 삭제
  ↓
JavaScript로 DOM에서 대댓글 제거
```

### 댓글 삭제 (스마트 삭제)
```
사용자가 삭제 버튼 클릭
  ↓
htmx POST /comments/{id}/delete
  ↓
CommentController.deleteComment()
  - 답글 유무 확인
  - 댓글 소프트 삭제
  ↓
답글이 있는 경우:
  - comment-item Fragment 반환
  - "삭제된 댓글입니다" 메시지 표시
  - 답글은 그대로 유지
  ↓
답글이 없는 경우:
  - empty Fragment 반환
  - 댓글 완전히 제거
```

## 테스트 방법

1. 게시글 작성
2. 댓글 작성
3. 댓글의 "답글" 버튼 클릭
4. 대댓글 작성 후 등록
5. 대댓글이 즉시 표시되는지 확인
6. 대댓글 삭제 테스트

## 주요 버그 수정

1. **대댓글 작성 폼 필수 필드 누락**: `targetType`, `targetId`, `type` 필드 추가
2. **대댓글 컨테이너 표시 안됨**: htmx afterSwap 이벤트로 `d-none` 클래스 제거
3. **폼 초기화 안됨**: 대댓글 추가 후 textarea 값 초기화
4. **삭제된 댓글 영구 표시**: 답글이 있는 삭제된 댓글이 새로고침 후에도 계속 표시되도록 Repository 쿼리 수정

### 삭제된 댓글 영구 표시 구현

**문제**: 답글이 있는 댓글을 삭제하면 일시적으로 "삭제된 댓글입니다"가 표시되지만, 새로고침하면 사라짐

**해결**: CommentRepository의 쿼리를 수정하여 삭제된 댓글이라도 답글이 있으면 계속 조회되도록 변경

```java
@Query("SELECT DISTINCT c FROM Comment c " +
       "LEFT JOIN Comment r ON r.parent.id = c.id AND r.deletedAt IS NULL " +
       "WHERE c.post.id = :postId AND c.parent IS NULL " +
       "AND (c.deletedAt IS NULL OR r.id IS NOT NULL) " +
       "ORDER BY c.createdAt ASC")
Page<Comment> findByPostIdAndParentIsNullPageable(@Param("postId") Long postId, Pageable pageable);
```

**조회 조건**:
- `c.deletedAt IS NULL`: 삭제되지 않은 댓글
- `r.id IS NOT NULL`: 삭제되었지만 답글이 있는 댓글

**결과**: 답글이 있는 삭제된 댓글은 새로고침 후에도 "삭제된 댓글입니다" 메시지와 함께 답글이 계속 표시됩니다.

## 향후 개선 사항

1. 대댓글 수정 기능 추가
2. 대댓글 알림 기능
3. @멘션 기능 (답글 대상 표시)
4. 대댓글 페이지네이션

## 마이페이지 연동

### 내가 작성한 댓글 페이지 개선

마이페이지의 "내가 작성한 댓글" 페이지에서 **삭제된 부모 댓글에 대한 답글**을 명확히 표시하도록 개선되었습니다.

**표시 내용**:
- 일반 댓글: 게시글/공구 제목 표시
- 답글 (부모 댓글 존재): 부모 댓글 내용 미리보기 표시
- 답글 (부모 댓글 삭제됨): "삭제된 댓글의 답글" 표시 + 삭제됨 배지

**구현**:
1. CommentRepository 쿼리에 `LEFT JOIN FETCH c.parent` 추가
2. my-comments.html 템플릿에서 `comment.parent.deletedAt` 체크
3. 삭제된 부모 댓글에 대한 답글임을 시각적으로 표시

**사용자 경험**:
- 삭제된 게시글의 댓글: "원본이 삭제되었습니다" 표시
- 삭제된 댓글의 답글: "삭제된 댓글의 답글" + 빨간색 배지 표시
- 정상 답글: 부모 댓글 내용 미리보기 (50자 제한)

**시각적 구분**:
1. **배지**: 
   - 댓글: 파란색 배지 `[💬 댓글]`
   - 답글: 초록색 배지 `[↩️ 답글]`
2. **카드 스타일**:
   - 댓글: 일반 카드
   - 답글: 왼쪽에 초록색 굵은 선 (border-start border-success border-4)


