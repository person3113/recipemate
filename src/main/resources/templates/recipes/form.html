<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(
        ~{::title},
        ~{::main-content},
        ~{::additional-head},
        ~{::additional-scripts}
      )}">
<head>
    <th:block th:fragment="title"><th:block th:text="${isEdit ? '레시피 수정' : '레시피 작성'}">레시피 작성</th:block></th:block>

    <th:block th:fragment="additional-head">
        <!-- 폼 페이지에는 추가 CSS가 필요 없음 -->
    </th:block>
</head>
<body>
    <main th:fragment="main-content" class="container my-5">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">
                            <i class="bi bi-pencil-square"></i>
                            <span th:text="${isEdit ? '레시피 수정' : '레시피 작성'}">레시피 작성</span>
                        </h3>
                    </div>

                    <div class="card-body p-4">
                        <!-- 폼 시작 -->
                        <form id="recipeForm"
                              th:action="${isEdit ? '/recipes/' + recipeId + '/edit' : '/recipes'}"
                              method="post"
                              enctype="multipart/form-data"
                              th:object="${recipe}">
                            
                            <!-- redirectUrl이 있으면 hidden field로 전달 -->
                            <input type="hidden" name="redirectUrl" th:if="${redirectUrl}" th:value="${redirectUrl}"/>

                            <!-- 기본 정보 -->
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2 mb-3">기본 정보</h5>

                                <!-- 제목 -->
                                <div class="mb-3">
                                    <label for="title" class="form-label">레시피 제목 <span class="text-danger">*</span></label>
                                    <input type="text"
                                           class="form-control"
                                           id="title"
                                           th:field="*{title}"
                                           placeholder="예: 김치찌개"
                                           required>
                                    <div th:if="${#fields.hasErrors('title')}" class="text-danger small" th:errors="*{title}"></div>
                                </div>

                                <!-- 카테고리 + 지역 -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="category" class="form-label">카테고리</label>
                                        <select class="form-select" id="category" th:field="*{category}">
                                            <option value="">선택 안함</option>
                                            <option value="한식">한식</option>
                                            <option value="양식">양식</option>
                                            <option value="중식">중식</option>
                                            <option value="일식">일식</option>
                                            <option value="디저트">디저트</option>
                                            <option value="기타">기타</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="area" class="form-label">지역/국가</label>
                                        <input type="text" class="form-control" id="area" th:field="*{area}" placeholder="예: 한국">
                                    </div>
                                </div>

                                <!-- 대표 이미지 -->
                                <div class="mb-3">
                                    <label for="mainImage" class="form-label">대표 이미지</label>
                                    <input type="file"
                                           class="form-control"
                                           id="mainImage"
                                           name="mainImage"
                                           accept="image/jpeg,image/jpg,image/png"
                                           onchange="previewMainImage(event)">
                                    <small class="text-muted">최대 5MB, JPG/PNG 형식</small>

                                    <!-- 이미지 미리보기 -->
                                    <div id="mainImagePreview" class="mt-2" style="display:none;">
                                        <img id="mainImagePreviewImg" src="" alt="미리보기" class="img-thumbnail" style="max-height: 200px;">
                                    </div>

                                    <!-- 수정 시 기존 이미지 표시 -->
                                    <div th:if="${isEdit and recipe.existingMainImageUrl != null}" class="mt-2">
                                        <p class="small text-muted">현재 이미지:</p>
                                        <img th:src="${recipe.existingMainImageUrl}" alt="현재 이미지" class="img-thumbnail" style="max-height: 200px;">
                                    </div>
                                </div>
                            </div>

                            <!-- 재료 -->
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-basket3"></i> 재료 <span class="text-danger">*</span>
                                </h5>

                                <div id="ingredientsList">
                                    <!-- 수정 모드: 기존 재료 표시 -->
                                    <div th:if="${isEdit and recipe.ingredients != null and !recipe.ingredients.isEmpty()}">
                                        <div th:each="ingredient, iterStat : ${recipe.ingredients}" class="ingredient-item mb-2">
                                            <div class="row">
                                                <div class="col-md-5">
                                                    <input type="text"
                                                           class="form-control ingredient-name-input"
                                                           th:value="${ingredient.name}"
                                                           placeholder="재료명"
                                                           required>
                                                </div>
                                                <div class="col-md-5">
                                                    <input type="text"
                                                           class="form-control ingredient-measure-input"
                                                           th:value="${ingredient.measure}"
                                                           placeholder="분량"
                                                           required>
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-danger" onclick="removeIngredient(this)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 작성 모드: 빈 재료 입력 폼 -->
                                    <div th:if="${!isEdit or recipe.ingredients == null or recipe.ingredients.isEmpty()}" class="ingredient-item mb-2">
                                        <div class="row">
                                            <div class="col-md-5">
                                                <input type="text"
                                                       class="form-control ingredient-name-input"
                                                       placeholder="재료명 (예: 돼지고기)"
                                                       required>
                                            </div>
                                            <div class="col-md-5">
                                                <input type="text"
                                                       class="form-control ingredient-measure-input"
                                                       placeholder="분량 (예: 300g)"
                                                       required>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-danger" onclick="removeIngredient(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addIngredient()">
                                    <i class="bi bi-plus-circle"></i> 재료 추가
                                </button>
                            </div>

                            <!-- 조리 방법 (단계별) -->
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-list-ol"></i> 조리 방법 <span class="text-danger">*</span>
                                </h5>

                                <div id="stepsList">
                                    <!-- 수정 모드: 기존 단계 표시 -->
                                    <div th:if="${isEdit and recipe.steps != null and !recipe.steps.isEmpty()}">
                                        <div th:each="step, iterStat : ${recipe.steps}" class="step-item mb-3">
                                            <div class="d-flex align-items-start">
                                                <span class="badge bg-primary rounded-circle me-2 mt-1"
                                                      style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;"
                                                      th:text="${iterStat.index + 1}">1</span>
                                                <div class="flex-grow-1 me-2">
                                                    <textarea class="form-control step-description-input"
                                                              th:text="${step.description}"
                                                              rows="3"
                                                              placeholder="조리 단계를 입력하세요"
                                                              required></textarea>
                                                </div>
                                                <button type="button" class="btn btn-danger" onclick="removeStep(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 작성 모드: 빈 단계 입력 폼 -->
                                    <div th:if="${!isEdit or recipe.steps == null or recipe.steps.isEmpty()}" class="step-item mb-3">
                                        <div class="d-flex align-items-start">
                                            <span class="badge bg-primary rounded-circle me-2 mt-1"
                                                  style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">1</span>
                                            <div class="flex-grow-1 me-2">
                                                <textarea class="form-control step-description-input"
                                                          rows="3"
                                                          placeholder="조리 단계를 입력하세요 (예: 돼지고기를 한입 크기로 썰어주세요)"
                                                          required></textarea>
                                            </div>
                                            <button type="button" class="btn btn-danger" onclick="removeStep(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addStep()">
                                    <i class="bi bi-plus-circle"></i> 단계 추가
                                </button>
                                <small class="text-muted d-block mt-2">각 단계별로 나누어 작성하면 보기 편해요!</small>
                            </div>

                            <!-- 추가 정보 -->
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2 mb-3">추가 정보 (선택사항)</h5>

                                <div class="mb-3">
                                    <label for="tips" class="form-label">요리 팁</label>
                                    <textarea class="form-control" id="tips" th:field="*{tips}" rows="3" placeholder="저감 조리법 팁이나 주의사항을 입력하세요"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="youtubeUrl" class="form-label">YouTube 링크</label>
                                    <input type="url" class="form-control" id="youtubeUrl" th:field="*{youtubeUrl}" placeholder="https://www.youtube.com/watch?v=...">
                                </div>

                                <div class="mb-3">
                                    <label for="sourceUrl" class="form-label">참고 링크</label>
                                    <input type="url" class="form-control" id="sourceUrl" th:field="*{sourceUrl}" placeholder="https://...">
                                </div>
                            </div>

                            <!-- 버튼 -->
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="history.back()">
                                    <i class="bi bi-arrow-left"></i> 취소
                                </button>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-circle"></i>
                                    <span th:text="${isEdit ? '수정 완료' : '등록하기'}">등록하기</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <th:block th:fragment="additional-scripts">
        <script>
            // 재료 카운터 초기화 (수정 모드에서는 기존 재료 개수로 시작)
            let ingredientCount = document.querySelectorAll('.ingredient-item').length;
            // 조리 단계 카운터 초기화
            let stepCount = document.querySelectorAll('.step-item').length;

            // 재료 추가
            function addIngredient() {
                const ingredientsList = document.getElementById('ingredientsList');
                const newIngredient = document.createElement('div');
                newIngredient.className = 'ingredient-item mb-2';
                newIngredient.innerHTML = `
                    <div class="row">
                        <div class="col-md-5">
                            <input type="text" class="form-control ingredient-name-input" placeholder="재료명" required>
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control ingredient-measure-input" placeholder="분량" required>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger" onclick="removeIngredient(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                ingredientsList.appendChild(newIngredient);
                ingredientCount++;
            }

            // 재료 삭제
            function removeIngredient(button) {
                const ingredientItem = button.closest('.ingredient-item');
                if (document.querySelectorAll('.ingredient-item').length > 1) {
                    ingredientItem.remove();
                } else {
                    alert('최소 1개의 재료가 필요합니다.');
                }
            }

            // 조리 단계 추가
            function addStep() {
                const stepsList = document.getElementById('stepsList');
                const newStep = document.createElement('div');
                newStep.className = 'step-item mb-3';
                const stepNumber = stepCount + 1;
                newStep.innerHTML = `
                    <div class="d-flex align-items-start">
                        <span class="badge bg-primary rounded-circle me-2 mt-1"
                              style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">${stepNumber}</span>
                        <div class="flex-grow-1 me-2">
                            <textarea class="form-control step-description-input"
                                      rows="3"
                                      placeholder="조리 단계를 입력하세요"
                                      required></textarea>
                        </div>
                        <button type="button" class="btn btn-danger" onclick="removeStep(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                stepsList.appendChild(newStep);
                stepCount++;
            }

            // 조리 단계 삭제
            function removeStep(button) {
                const stepItem = button.closest('.step-item');
                if (document.querySelectorAll('.step-item').length > 1) {
                    stepItem.remove();
                    // 삭제 후 번호 재정렬
                    reindexSteps();
                } else {
                    alert('최소 1개의 조리 단계가 필요합니다.');
                }
            }

            // 조리 단계 번호 재정렬
            function reindexSteps() {
                const stepItems = document.querySelectorAll('.step-item');
                stepItems.forEach((item, index) => {
                    const badge = item.querySelector('.badge');
                    if (badge) badge.textContent = index + 1;
                });
                stepCount = stepItems.length;
            }

            // 대표 이미지 미리보기
            function previewMainImage(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('mainImagePreviewImg').src = e.target.result;
                        document.getElementById('mainImagePreview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // 폼 제출 시 재료와 조리 단계를 JSON으로 변환 (Tomcat 파일 개수 제한 우회)
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('recipeForm');
                
                if (!form) {
                    console.error('레시피 폼을 찾을 수 없습니다.');
                    return;
                }
                
                // 폼 제출 시 재료와 조리 단계를 JSON으로 변환
                form.addEventListener('submit', function(e) {
                    console.log('=== 폼 제출 시작 ===');
                    
                    // 1. 재료 데이터 수집
                    const ingredientItems = document.querySelectorAll('.ingredient-item');
                    const ingredientsData = [];
                    
                    console.log('재료 아이템 개수:', ingredientItems.length);
                    
                    ingredientItems.forEach((item, index) => {
                        const nameInput = item.querySelector('.ingredient-name-input');
                        const measureInput = item.querySelector('.ingredient-measure-input');
                        
                        console.log(`재료 ${index + 1}:`, {
                            nameInput: nameInput,
                            nameValue: nameInput ? nameInput.value : 'null',
                            measureInput: measureInput,
                            measureValue: measureInput ? measureInput.value : 'null'
                        });
                        
                        if (nameInput && measureInput && nameInput.value.trim() !== '') {
                            ingredientsData.push({
                                name: nameInput.value.trim(),
                                measure: measureInput.value.trim()
                            });
                        }
                    });
                    
                    console.log('수집된 재료 데이터:', ingredientsData);
                    
                    // 2. 조리 단계 데이터 수집
                    const stepItems = document.querySelectorAll('.step-item');
                    const stepsData = [];
                    
                    console.log('조리 단계 아이템 개수:', stepItems.length);
                    
                    stepItems.forEach((item, index) => {
                        const textarea = item.querySelector('.step-description-input');
                        
                        console.log(`조리 단계 ${index + 1}:`, {
                            textarea: textarea,
                            value: textarea ? textarea.value : 'null'
                        });
                        
                        if (textarea && textarea.value.trim() !== '') {
                            stepsData.push({
                                description: textarea.value.trim()
                            });
                        }
                    });
                    
                    console.log('수집된 조리 단계 데이터:', stepsData);
                    
                    // 3. 최소 개수 검증
                    if (ingredientsData.length === 0) {
                        e.preventDefault();
                        alert('최소 1개 이상의 재료를 입력해주세요.');
                        return false;
                    }
                    
                    if (stepsData.length === 0) {
                        e.preventDefault();
                        alert('최소 1개 이상의 조리 단계를 입력해주세요.');
                        return false;
                    }
                    
                    // 4. JSON 문자열로 변환하여 hidden input에 저장
                    let ingredientsJsonInput = document.getElementById('ingredientsJson');
                    if (!ingredientsJsonInput) {
                        ingredientsJsonInput = document.createElement('input');
                        ingredientsJsonInput.type = 'hidden';
                        ingredientsJsonInput.id = 'ingredientsJson';
                        ingredientsJsonInput.name = 'ingredientsJson';
                        form.appendChild(ingredientsJsonInput);
                    }
                    ingredientsJsonInput.value = JSON.stringify(ingredientsData);
                    console.log('ingredientsJson 생성:', ingredientsJsonInput.value);
                    
                    let stepsJsonInput = document.getElementById('stepsJson');
                    if (!stepsJsonInput) {
                        stepsJsonInput = document.createElement('input');
                        stepsJsonInput.type = 'hidden';
                        stepsJsonInput.id = 'stepsJson';
                        stepsJsonInput.name = 'stepsJson';
                        form.appendChild(stepsJsonInput);
                    }
                    stepsJsonInput.value = JSON.stringify(stepsData);
                    console.log('stepsJson 생성:', stepsJsonInput.value);
                    
                    console.log('=== 폼 제출 준비 완료 ===');
                    // e.preventDefault()를 호출하지 않았으므로 자연스럽게 폼이 제출됨
                });
            });
        </script>
    </th:block>
</body>
</html>
