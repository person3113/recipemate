<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>참여자 관리 - RecipeMate</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body class="bg-light">
    <div th:replace="~{fragments/header :: header}"></div>
    
    <main class="container py-4">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <!-- 공구 정보 카드 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h1 class="h4 mb-2">
                                    <i class="bi bi-people-fill"></i> 참여자 관리
                                </h1>
                                <h5 class="text-muted mb-0" th:text="${groupBuy.title}">공구 제목</h5>
                            </div>
                            <a th:href="@{/group-purchases/{id}(id=${groupBuy.id})}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> 공구로 돌아가기
                            </a>
                        </div>
                        
                        <!-- 공구 요약 정보 -->
                        <div class="row text-muted small">
                            <div class="col-md-4">
                                <i class="bi bi-people"></i> 
                                참여 현황: 
                                <span class="fw-bold text-primary" th:text="${groupBuy.currentHeadcount} + '/' + ${groupBuy.targetHeadcount} + '명'">0/10명</span>
                            </div>
                            <div class="col-md-4">
                                <i class="bi bi-tag"></i> 
                                상태: 
                                <span class="badge" 
                                      th:classappend="${groupBuy.status.name() == 'RECRUITING'} ? 'bg-info' : (${groupBuy.status.name() == 'CLOSED'} ? 'bg-secondary' : 'bg-success')"
                                      th:text="${groupBuy.status.name() == 'RECRUITING'} ? '모집중' : (${groupBuy.status.name() == 'CLOSED'} ? '마감' : '완료')">
                                    상태
                                </span>
                            </div>
                            <div class="col-md-4">
                                <i class="bi bi-calendar"></i> 
                                마감일: <span th:text="${#temporals.format(groupBuy.deadline, 'yyyy-MM-dd')}">2024-01-01</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 참여자 목록 -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul"></i> 참여자 목록 
                            <span class="badge bg-primary" th:text="${participants.size()}">0</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- 참여자가 없는 경우 -->
                        <div th:if="${participants == null or participants.isEmpty()}" class="text-center py-5">
                            <i class="bi bi-person-x display-1 text-muted"></i>
                            <h5 class="mt-3">참여자가 없습니다</h5>
                            <p class="text-muted">아직 참여한 사용자가 없습니다.</p>
                        </div>
                        
                        <!-- 참여자 목록 테이블 -->
                        <div th:if="${participants != null and !participants.isEmpty()}" class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">닉네임</th>
                                        <th scope="col">매너온도</th>
                                        <th scope="col">참여일</th>
                                        <th scope="col">수령 방법</th>
                                        <th scope="col">수량</th>
                                        <th scope="col">액션</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="participant, iterStat : ${participants}">
                                        <td th:text="${iterStat.count}">1</td>
                                        <td>
                                            <strong th:text="${participant.nickname}">닉네임</strong>
                                        </td>
                                        <td>
                                            <span class="badge" 
                                                  th:classappend="${participant.mannerTemperature >= 40} ? 'bg-success' : (${participant.mannerTemperature >= 30} ? 'bg-primary' : 'bg-secondary')"
                                                  th:text="${#numbers.formatDecimal(participant.mannerTemperature, 1, 1)} + '°C'">
                                                36.5°C
                                            </span>
                                        </td>
                                        <td th:text="${#temporals.format(participant.participatedAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 12:00</td>
                                        <td>
                                            <span th:if="${participant.selectedDeliveryMethod.name() == 'DIRECT'}" class="badge bg-info">
                                                <i class="bi bi-person-arms-up"></i> 직거래
                                            </span>
                                            <span th:if="${participant.selectedDeliveryMethod.name() == 'PARCEL'}" class="badge bg-warning">
                                                <i class="bi bi-box-seam"></i> 택배
                                            </span>
                                        </td>
                                        <td>
                                            <span class="fw-bold" th:text="${participant.quantity} + '개'">1개</span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group" th:if="${participant.userId != currentUserId}">
                                                <!-- TODO: 1:1 쪽지 보내기 기능 (향후 구현) -->
                                                <button type="button" class="btn btn-sm btn-outline-secondary" disabled title="1:1 쪽지 기능은 추후 구현 예정입니다">
                                                    <i class="bi bi-envelope"></i> 쪽지
                                                </button>
                                                
                                                <!-- 강제 탈퇴 버튼 -->
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#removeModal"
                                                        th:data-user-id="${participant.userId}"
                                                        th:data-nickname="${participant.nickname}"
                                                        title="참여자를 강제 탈퇴시킵니다">
                                                    <i class="bi bi-person-x"></i> 탈퇴
                                                </button>
                                            </div>
                                            <span th:if="${participant.userId == currentUserId}" class="text-muted small">
                                                <i class="bi bi-person-check"></i> 본인
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 안내 메시지 -->
                <div class="alert alert-info mt-4" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <strong>안내:</strong> 1:1 쪽지 보내기 기능은 추후 구현될 예정입니다.
                </div>
            </div>
        </div>
    </main>
    
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <!-- 강제 탈퇴 확인 모달 -->
    <div class="modal fade" id="removeModal" tabindex="-1" aria-labelledby="removeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="removeModalLabel">
                        <i class="bi bi-exclamation-triangle text-warning"></i> 참여자 강제 탈퇴
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">정말로 <strong id="targetNickname"></strong>님을 강제 탈퇴시키시겠습니까?</p>
                    <div class="alert alert-warning small mb-0">
                        <i class="bi bi-info-circle"></i>
                        이 작업은 되돌릴 수 없으며, 해당 참여자에게 알림이 전송됩니다.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <form id="removeForm" method="post" style="display: inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-person-x"></i> 탈퇴시키기
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 강제 탈퇴 모달 JavaScript -->
    <script th:inline="javascript">
        const removeModal = document.getElementById('removeModal');
        const removeForm = document.getElementById('removeForm');
        const targetNickname = document.getElementById('targetNickname');
        const groupBuyId = /*[[${groupBuy.id}]]*/ 0;
        
        removeModal.addEventListener('show.bs.modal', function (event) {
            // 버튼에서 데이터 가져오기
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');
            const nickname = button.getAttribute('data-nickname');
            
            // 모달 내용 업데이트
            targetNickname.textContent = nickname;
            removeForm.action = `/group-purchases/${groupBuyId}/participants/${userId}/remove`;
        });
    </script>

</body>
</html>
