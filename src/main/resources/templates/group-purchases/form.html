<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(
        ~{::title}, 
        ~{::main-content}, 
        ~{::additional-head},
        ~{::additional-scripts}
      )}">
<head>
    <th:block th:fragment="title" th:text="${groupBuy != null ? '공동구매 수정' : '공동구매 작성'}">공동구매 작성</th:block>
    
    <!-- Additional Head Content -->
    <th:block th:fragment="additional-head">
        <!-- No additional head content needed -->
    </th:block>
</head>
<body>
    <!-- Main Content Fragment -->
    <main th:fragment="main-content" class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Page Header -->
                <div class="mb-4">
                    <h1 class="fw-bold">
                        <i class="bi bi-basket3"></i>
                        <span th:text="${groupBuy != null ? '공동구매 수정' : (recipe != null ? '레시피 기반 공동구매 작성' : '공동구매 작성')}">공동구매 작성</span>
                    </h1>
                    <p class="text-muted" th:text="${recipe != null ? '레시피 재료를 선택하고 공동구매를 만들어보세요' : '함께 구매할 상품의 정보를 입력해주세요'}">함께 구매할 상품의 정보를 입력해주세요</p>
                </div>
                
                <!-- Flash Messages -->
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-circle"></i> <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <!-- Form Card -->
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <form id="groupBuyForm" method="post" 
                              th:action="${groupBuy != null ? '/group-purchases/' + groupBuy.id : (recipe != null ? '/group-purchases/recipe-based' : '/group-purchases')}"
                              th:object="${formData}"
                              enctype="multipart/form-data">
                            <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" th:if="${redirectUrl}" name="redirectUrl" th:value="${redirectUrl}"/>
                            
                            <!-- Recipe Info Section (레시피 기반 공구인 경우만 표시) -->
                            <div th:if="${recipe != null}" class="alert alert-info mb-4">
                                <div class="d-flex align-items-center">
                                    <img th:if="${recipe.imageUrl != null}" 
                                         th:src="${recipe.imageUrl}" 
                                         th:alt="${recipe.name}" 
                                         class="rounded me-3"
                                         style="width: 80px; height: 80px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                        <h5 class="mb-1 fw-bold">
                                            <i class="bi bi-egg-fried"></i> <span th:text="${recipe.name}">레시피명</span>
                                        </h5>
                                        <p class="mb-0 small text-muted">
                                            <span th:text="${recipe.category}">카테고리</span>
                                            <span th:if="${recipe.area != null}"> · <span th:text="${recipe.area}">지역</span></span>
                                        </p>
                                    </div>
                                </div>
                                <!-- Hidden fields for recipe info -->
                                <input type="hidden" name="recipeApiId" th:value="${recipe.id}">
                                <input type="hidden" name="recipeName" th:value="${recipe.name}">
                                <input type="hidden" name="recipeImageUrl" th:value="${recipe.imageUrl}">
                            </div>
                            
                            <!-- Ingredients Selection (모든 공구 유형에서 표시) -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">
                                    필요한 재료 선택 <span class="text-danger">*</span>
                                </label>
                                <div class="card">
                                    <div class="card-body">
                                        <p class="text-muted small mb-3">
                                            <i class="bi bi-info-circle"></i> 
                                            <span th:if="${groupBuy != null}">
                                                공동구매에 포함할 재료를 수정하세요. 분량은 수정할 수 있습니다.
                                            </span>
                                            <span th:if="${groupBuy == null and recipe != null}">
                                                공동구매에 포함할 재료를 선택하세요. 분량은 수정할 수 있습니다.
                                            </span>
                                            <span th:if="${groupBuy == null and recipe == null}">
                                                공동구매에 필요한 재료를 추가하세요.
                                            </span>
                                        </p>
                                        <div class="row g-2" id="ingredientsList">
                                            <!-- 레시피 기반 생성 (공구 수정이 아닌 경우만): recipe.ingredients를 표시 -->
                                            <th:block th:if="${recipe != null and groupBuy == null}">
                                                <div th:each="ingredient, stat : ${recipe.ingredients}" class="col-md-6">
                                                    <div class="border rounded p-3 ingredient-item">
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input ingredient-checkbox" 
                                                                   type="checkbox" 
                                                                   th:id="'ingredient-' + ${stat.index}"
                                                                   th:data-name="${ingredient.name}"
                                                                   th:data-measure="${ingredient.measure}"
                                                                   checked>
                                                            <label class="form-check-label fw-semibold w-100" th:for="'ingredient-' + ${stat.index}">
                                                                <input type="text" 
                                                                       class="form-control form-control-sm d-inline-block ingredient-name-input" 
                                                                       th:id="'name-' + ${stat.index}"
                                                                       th:value="${ingredient.name}"
                                                                       placeholder="재료명"
                                                                       style="width: 100%;">
                                                            </label>
                                                        </div>
                                                        <input type="text" 
                                                               class="form-control form-control-sm ingredient-measure" 
                                                               th:id="'measure-' + ${stat.index}"
                                                               th:value="${ingredient.measure}"
                                                               placeholder="분량 (예: 200g, 2개)">
                                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-ingredient">
                                                            <i class="bi bi-trash"></i> 제거
                                                        </button>
                                                    </div>
                                                </div>
                                            </th:block>
                                            
                                            <!-- 공구 수정 (일반/레시피 모두): ingredientsList를 표시 -->
                                            <div th:if="${groupBuy != null and ingredientsList != null}" th:each="ingredient, stat : ${ingredientsList}" class="col-md-6">
                                                <div class="border rounded p-3 ingredient-item">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input ingredient-checkbox" 
                                                               type="checkbox" 
                                                               th:id="'ingredient-' + ${stat.index}"
                                                               th:data-name="${ingredient.name}"
                                                               th:data-measure="${ingredient.measure}"
                                                               checked>
                                                        <label class="form-check-label fw-semibold w-100" th:for="'ingredient-' + ${stat.index}">
                                                            <input type="text" 
                                                                   class="form-control form-control-sm d-inline-block ingredient-name-input" 
                                                                   th:id="'name-' + ${stat.index}"
                                                                   th:value="${ingredient.name}"
                                                                   placeholder="재료명"
                                                                   style="width: 100%;">
                                                        </label>
                                                    </div>
                                                    <input type="text" 
                                                           class="form-control form-control-sm ingredient-measure" 
                                                           th:id="'measure-' + ${stat.index}"
                                                           th:value="${ingredient.measure}"
                                                           placeholder="분량 (예: 200g, 2개)">
                                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-ingredient">
                                                        <i class="bi bi-trash"></i> 제거
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="addIngredientBtn">
                                                <i class="bi bi-plus-circle"></i> 재료 추가
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Title -->
                            <div class="mb-4">
                                <label for="title" class="form-label fw-semibold">
                                    제목 <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       id="title" 
                                       th:field="*{title}"
                                       class="form-control"
                                       th:classappend="${#fields.hasErrors('title')} ? 'is-invalid'"
                                       th:placeholder="${groupBuy == null and recipe == null} ? '공동구매 제목을 입력하세요' : ''"
                                       required
                                       maxlength="100">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
                            </div>
                            
                            <!-- Category -->
                            <div class="mb-4">
                                <label for="category" class="form-label fw-semibold">
                                    카테고리 <span class="text-danger">*</span>
                                </label>
                                <select id="category" th:field="*{category}" class="form-select" required>
                                    <option value="">카테고리를 선택하세요</option>
                                    <option th:each="cat : ${categories}" 
                                            th:value="${cat.name()}" 
                                            th:text="${cat.displayName}"></option>
                                </select>
                            </div>
                            
                            <!-- Content -->
                            <div class="mb-4">
                                <label for="content" class="form-label fw-semibold">
                                    상세 설명 <span class="text-danger">*</span>
                                </label>
                                <textarea id="content" 
                                          th:field="*{content}"
                                          class="form-control" 
                                          rows="8"
                                          placeholder="공동구매에 대한 상세한 설명을 입력하세요"
                                          required></textarea>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> 상품의 상태, 수령 방법 등을 자세히 작성해주세요.
                                </div>
                            </div>
                            
                            <div class="row">
                                <!-- Target Amount -->
                                <div class="col-md-6 mb-4">
                                    <label for="targetAmount" class="form-label fw-semibold">
                                        목표 금액 <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" 
                                               id="targetAmount" 
                                               th:field="*{targetAmount}"
                                               class="form-control" 
                                               min="0"
                                               max="2147483647"
                                               step="1000"
                                               placeholder="0"
                                               required>
                                        <span class="input-group-text">원</span>
                                    </div>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> 최대 21억원까지 입력 가능합니다.
                                    </div>
                                </div>
                                
                                <!-- Target Headcount -->
                                <div class="col-md-6 mb-4">
                                    <label for="targetHeadcount" class="form-label fw-semibold">
                                        목표 인원 <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" 
                                               id="targetHeadcount" 
                                               th:field="*{targetHeadcount}"
                                               class="form-control" 
                                               min="2" 
                                               max="100"
                                               placeholder="2"
                                               required>
                                        <span class="input-group-text">명</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Price Per Person (Auto-calculated) -->
                            <div class="alert alert-success mb-4" id="pricePerPersonAlert" style="display: none;">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <i class="bi bi-calculator"></i>
                                        <strong>1인당 예상 가격:</strong>
                                    </div>
                                    <div class="fs-5 fw-bold" id="pricePerPerson">0원</div>
                                </div>
                            </div>
                            
                            <!-- Deadline -->
                            <div class="mb-4">
                                <label for="deadline" class="form-label fw-semibold">
                                    마감일 <span class="text-danger">*</span>
                                </label>
                                <input type="datetime-local" 
                                       id="deadline" 
                                       th:field="*{deadline}"
                                       class="form-control"
                                       th:classappend="${#fields.hasErrors('deadline')} ? 'is-invalid'"
                                       step="1800"
                                       required>
                                <div class="form-text">
                                    <i class="bi bi-calendar-event"></i> 현재 시각 이후 ~ 1개월 이내, 30분 단위로 설정해주세요.
                                </div>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('deadline')}" th:errors="*{deadline}"></div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <h5 class="fw-bold mb-3">배송 정보</h5>
                            
                            <!-- Delivery Method -->
                            <div class="mb-4">
                                <label for="deliveryMethod" class="form-label fw-semibold">
                                    배송 방법 <span class="text-danger">*</span>
                                </label>
                                <select id="deliveryMethod" th:field="*{deliveryMethod}" class="form-select" required>
                                    <option value="">배송 방법을 선택하세요</option>
                                    <option value="DIRECT">
                                        <i class="bi bi-person-arms-up"></i> 직거래
                                    </option>
                                    <option value="PARCEL">
                                        <i class="bi bi-box-seam"></i> 택배
                                    </option>
                                    <option value="BOTH">
                                        <i class="bi bi-arrow-left-right"></i> 직거래 / 택배
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Meetup Location -->
                            <div class="mb-4">
                                <label for="meetupLocation" class="form-label fw-semibold">
                                    만남 장소 <span class="text-muted small">(직거래 시)</span>
                                </label>
                                <div class="input-group mb-2">
                                    <input type="text" 
                                           id="meetupLocation" 
                                           th:field="*{meetupLocation}"
                                           class="form-control" 
                                           placeholder="주소 검색 버튼을 눌러 주소를 선택하세요"
                                           readonly>
                                    <button type="button" 
                                            id="searchAddressBtn" 
                                            class="btn btn-primary">
                                        <i class="bi bi-search"></i> 주소 검색
                                    </button>
                                </div>
                                <div class="form-text mb-3">
                                    <i class="bi bi-info-circle"></i> 주소 검색 후 지도에서 정확한 위치를 클릭하여 지정할 수 있습니다.
                                </div>
                                
                                <!-- Hidden inputs for coordinates -->
                                <input type="hidden" id="latitude" th:field="*{latitude}">
                                <input type="hidden" id="longitude" th:field="*{longitude}">
                                
                                <!-- Map Toggle Button -->
                                <button type="button" 
                                        id="toggleMapBtn" 
                                        class="btn btn-outline-secondary btn-sm mb-2" 
                                        onclick="toggleMapDisplay()">
                                    <i class="bi bi-map" id="mapToggleIcon"></i>
                                    <span id="mapToggleText">지도 보기</span>
                                </button>
                                
                                <!-- Map Container -->
                                <div id="mapContainer" style="display: none;">
                                    <div id="meetupMap" style="width: 100%; height: 400px; border-radius: 8px; border: 1px solid #dee2e6;"></div>
                                    <div class="form-text mt-2">
                                        <i class="bi bi-hand-index"></i> 지도를 클릭하여 정확한 위치를 지정할 수 있습니다.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Parcel Fee -->
                            <div class="mb-4">
                                <label for="parcelFee" class="form-label fw-semibold">
                                    택배비 <span class="text-muted small">(택배 배송 시)</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" 
                                           id="parcelFee" 
                                           th:field="*{parcelFee}"
                                           class="form-control" 
                                           min="0"
                                           step="500"
                                           placeholder="0">
                                    <span class="input-group-text">원</span>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <!-- Participant List Public -->
                            <div class="mb-4">
                                <div class="form-check">
                                    <input type="checkbox" 
                                           class="form-check-input" 
                                           id="isParticipantListPublic" 
                                           th:field="*{isParticipantListPublic}">
                                    <label class="form-check-label" for="isParticipantListPublic">
                                        <i class="bi bi-people"></i> 참여자 명단 공개
                                    </label>
                                    <div class="form-text">참여자 목록을 다른 사용자에게 공개합니다.</div>
                                </div>
                            </div>
                            
                            <!-- Existing Images (수정 모드인 경우) -->
                            <div th:if="${groupBuy != null and existingImages != null and !existingImages.isEmpty()}" class="mb-4">
                                <label class="form-label fw-semibold">
                                    기존 이미지 <span class="text-muted small">(삭제할 이미지를 선택하세요)</span>
                                </label>
                                <div id="existingImagesContainer" class="row g-2">
                                    <div th:each="imageUrl, stat : ${existingImages}" class="col-md-4">
                                        <div class="card existing-image-card" th:data-url="${imageUrl}">
                                            <img th:src="${imageUrl}" class="card-img-top" alt="공구 이미지" style="height: 150px; object-fit: cover;">
                                            <div class="card-body p-2 text-center">
                                                <button type="button" 
                                                        class="btn btn-sm btn-danger delete-existing-image-btn"
                                                        th:data-url="${imageUrl}"
                                                        onclick="markImageForDeletion(this, this.dataset.url)">
                                                    <i class="bi bi-trash"></i> 삭제
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hidden input for deleted images -->
                                <input type="hidden" id="deletedImagesInput" name="deletedImages" value="">
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="mb-4">
                                <label for="imageFiles" class="form-label fw-semibold">
                                    <span th:text="${groupBuy != null ? '새 이미지 추가' : '이미지 업로드'}">이미지 업로드</span>
                                    <span class="text-muted small">(최대 3장, 각 5MB)</span>
                                </label>
                                <input type="file" 
                                       id="imageFiles" 
                                       th:name="${groupBuy != null ? 'images' : 'imageFiles'}"
                                       class="form-control" 
                                       multiple 
                                       accept="image/jpeg,image/png">
                                <div class="form-text">
                                    <i class="bi bi-image"></i> JPG, PNG 형식만 업로드 가능하며, 각 파일은 5MB 이하여야 합니다.
                                </div>
                                <div id="imagePreviewContainer" class="mt-3 row g-2"></div>
                            </div>
                            
                            <!-- Form Actions -->
                            <div class="d-flex gap-2 mt-4">
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="bi bi-check-circle"></i>
                                    <span th:text="${groupBuy != null ? '수정하기' : '작성하기'}">작성하기</span>
                                </button>
                                <a th:href="${redirectUrl != null ? redirectUrl : (groupBuy != null ? '/group-purchases/' + groupBuy.id : '/group-purchases/list')}" 
                                   class="btn btn-outline-secondary px-4">
                                    <i class="bi bi-x-circle"></i> 취소
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Help Card -->
                <div class="card border-0 bg-light mt-3">
                    <div class="card-body">
                        <h6 class="fw-semibold mb-2">
                            <i class="bi bi-lightbulb text-warning"></i> 작성 가이드
                        </h6>
                        <ul class="small text-muted mb-0">
                            <li>신선한 식재료의 경우 수령 가능한 날짜와 시간을 명시해주세요.</li>
                            <li>목표 인원은 실제 구매 가능한 인원으로 설정해주세요.</li>
                            <li>배송 방법을 명확히 하여 참여자들의 혼란을 방지하세요.</li>
                            <li>상품의 상태, 브랜드, 원산지 등을 자세히 작성하면 참여율이 높아집니다.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Additional Scripts Fragment -->
    <th:block th:fragment="additional-scripts">
        <!-- Existing Image Deletion Script -->
        <script>
            // 기존 이미지 삭제 마크 (전역 함수로 선언)
            let deletedImagesArray = [];
            
            function markImageForDeletion(button, imageUrl) {
                // 삭제할 이미지 URL을 배열에 추가
                if (!deletedImagesArray.includes(imageUrl)) {
                    deletedImagesArray.push(imageUrl);
                }
                
                // Hidden input에 JSON 문자열로 저장
                const deletedImagesInput = document.getElementById('deletedImagesInput');
                if (deletedImagesInput) {
                    deletedImagesInput.value = JSON.stringify(deletedImagesArray);
                }
                
                // UI에서 카드 제거
                const card = button.closest('.existing-image-card');
                if (card) {
                    card.style.opacity = '0.5';
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-check"></i> 삭제 예정';
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-secondary');
                }
            }
        </script>
        
        <!-- Price Per Person Calculator -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const targetAmountInput = document.getElementById('targetAmount');
                const targetHeadcountInput = document.getElementById('targetHeadcount');
                const pricePerPersonAlert = document.getElementById('pricePerPersonAlert');
                const pricePerPersonDisplay = document.getElementById('pricePerPerson');
                const deadlineInput = document.getElementById('deadline');
                const imageFilesInput = document.getElementById('imageFiles');
                const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                
                const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
                const MAX_IMAGE_COUNT = 3;
                let selectedFiles = [];
                
                // 1인당 가격 계산
                function calculatePricePerPerson() {
                    const targetAmount = parseInt(targetAmountInput.value) || 0;
                    const targetHeadcount = parseInt(targetHeadcountInput.value) || 0;
                    
                    if (targetAmount > 0 && targetHeadcount > 0) {
                        const pricePerPerson = Math.ceil(targetAmount / targetHeadcount);
                        pricePerPersonDisplay.textContent = pricePerPerson.toLocaleString('ko-KR') + '원';
                        pricePerPersonAlert.style.display = 'block';
                    } else {
                        pricePerPersonAlert.style.display = 'none';
                    }
                }
                
                // 입력값 변경 시 자동 계산
                targetAmountInput.addEventListener('input', calculatePricePerPerson);
                targetHeadcountInput.addEventListener('input', calculatePricePerPerson);
                
                // 페이지 로드 시 초기 계산 (수정 모드인 경우)
                calculatePricePerPerson();
                
                // 마감일 최소값/최대값 설정 (현재 시각 ~ 1개월)
                function setDeadlineConstraints() {
                    const now = new Date();
                    
                    // 최소값: 현재 시각을 30분 단위로 반올림
                    const minutes = now.getMinutes();
                    const roundedMinutes = minutes < 30 ? 30 : 60;
                    now.setMinutes(roundedMinutes);
                    now.setSeconds(0);
                    now.setMilliseconds(0);
                    
                    if (roundedMinutes === 60) {
                        now.setHours(now.getHours() + 1);
                        now.setMinutes(0);
                    }
                    
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutesStr = String(now.getMinutes()).padStart(2, '0');
                    const minDateTime = `${year}-${month}-${day}T${hours}:${minutesStr}`;
                    deadlineInput.setAttribute('min', minDateTime);
                    
                    // 최대값: 현재 + 1개월
                    const maxDate = new Date();
                    maxDate.setMonth(maxDate.getMonth() + 1);
                    const maxYear = maxDate.getFullYear();
                    const maxMonth = String(maxDate.getMonth() + 1).padStart(2, '0');
                    const maxDay = String(maxDate.getDate()).padStart(2, '0');
                    const maxHours = String(maxDate.getHours()).padStart(2, '0');
                    const maxMinutes = String(maxDate.getMinutes()).padStart(2, '0');
                    const maxDateTime = `${maxYear}-${maxMonth}-${maxDay}T${maxHours}:${maxMinutes}`;
                    deadlineInput.setAttribute('max', maxDateTime);
                }
                
                setDeadlineConstraints();
                
                // 마감일 유효성 검증 (현재 시각 ~ 1개월 이내, 30분 단위)
                deadlineInput.addEventListener('change', function() {
                    const selectedDate = new Date(this.value);
                    const now = new Date();
                    const maxDate = new Date(now);
                    maxDate.setMonth(maxDate.getMonth() + 1);
                    
                    // 시간 범위 검증
                    if (selectedDate <= now) {
                        alert('마감일은 현재 시각 이후로 설정해주세요.');
                        this.value = '';
                        this.focus();
                        return;
                    } else if (selectedDate > maxDate) {
                        alert('마감일은 현재로부터 최대 1개월 이내로 설정해주세요.');
                        this.value = '';
                        this.focus();
                        return;
                    }
                    
                    // 30분 단위 자동 보정 (Snap)
                    const minutes = selectedDate.getMinutes();
                    if (minutes !== 0 && minutes !== 30) {
                        // 가장 가까운 30분 단위로 스냅
                        let snappedMinutes;
                        if (minutes < 15) {
                            snappedMinutes = 0;
                        } else if (minutes < 45) {
                            snappedMinutes = 30;
                        } else {
                            snappedMinutes = 0;
                            selectedDate.setHours(selectedDate.getHours() + 1);
                        }
                        
                        selectedDate.setMinutes(snappedMinutes);
                        selectedDate.setSeconds(0);
                        selectedDate.setMilliseconds(0);
                        
                        // 자동 보정된 시간으로 입력값 업데이트
                        const year = selectedDate.getFullYear();
                        const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
                        const day = String(selectedDate.getDate()).padStart(2, '0');
                        const hours = String(selectedDate.getHours()).padStart(2, '0');
                        const minutesStr = String(selectedDate.getMinutes()).padStart(2, '0');
                        this.value = `${year}-${month}-${day}T${hours}:${minutesStr}`;
                    }
                });
                
                // 이미지 압축 함수
                async function compressImage(file, maxWidth = 1024, quality = 0.8) {
                    return new Promise((resolve, reject) => {
                        // 이미 작은 이미지는 압축하지 않음
                        if (file.size < 500 * 1024) { // 500KB 미만
                            resolve(file);
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                
                                // 최대 너비 제한
                                if (width > maxWidth) {
                                    height = (height * maxWidth) / width;
                                    width = maxWidth;
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                // Blob으로 변환 (JPEG, 품질 80%)
                                canvas.toBlob((blob) => {
                                    if (blob) {
                                        const compressedFile = new File([blob], file.name, {
                                            type: 'image/jpeg',
                                            lastModified: Date.now()
                                        });
                                        console.log(`Image compressed: ${file.name} (${(file.size / 1024).toFixed(1)}KB → ${(blob.size / 1024).toFixed(1)}KB)`);
                                        resolve(compressedFile);
                                    } else {
                                        reject(new Error('Failed to compress image'));
                                    }
                                }, 'image/jpeg', quality);
                            };
                            img.onerror = () => reject(new Error('Failed to load image'));
                            img.src = e.target.result;
                        };
                        reader.onerror = () => reject(new Error('Failed to read file'));
                        reader.readAsDataURL(file);
                    });
                }
                
                // 이미지 파일 검증 및 미리보기
                if (imageFilesInput && imagePreviewContainer) {
                    imageFilesInput.addEventListener('change', async function(e) {
                        const files = Array.from(e.target.files);
                        
                        // 기존 이미지 개수 계산 (삭제 표시되지 않은 것만)
                        const existingImageCards = document.querySelectorAll('.existing-image-card');
                        const existingCount = Array.from(existingImageCards).filter(card => {
                            return card.style.opacity !== '0.5';
                        }).length;
                        
                        // 총 이미지 개수 검증 (기존 + 새 이미지 <= 3)
                        if (existingCount + files.length > MAX_IMAGE_COUNT) {
                            alert(`총 이미지는 최대 ${MAX_IMAGE_COUNT}장까지 가능합니다. (현재 ${existingCount}개 존재, ${files.length}개 추가 시도)`);
                            e.target.value = '';
                            return;
                        }
                        
                        // 파일 개수 검증 (새 이미지만)
                        if (files.length > MAX_IMAGE_COUNT) {
                            alert(`이미지는 최대 ${MAX_IMAGE_COUNT}장까지 업로드할 수 있습니다.`);
                            e.target.value = '';
                            return;
                        }
                        
                        // 파일 크기 및 형식 검증
                        for (let file of files) {
                            if (file.size > MAX_FILE_SIZE) {
                                alert(`${file.name}의 크기가 5MB를 초과합니다. 5MB 이하의 이미지만 업로드 가능합니다.`);
                                e.target.value = '';
                                imagePreviewContainer.innerHTML = '';
                                selectedFiles = [];
                                return;
                            }
                            
                            if (!['image/jpeg', 'image/png'].includes(file.type)) {
                                alert(`${file.name}은(는) JPG 또는 PNG 형식이 아닙니다.`);
                                e.target.value = '';
                                imagePreviewContainer.innerHTML = '';
                                selectedFiles = [];
                                return;
                            }
                        }
                        
                        // 이미지 압축 (비동기)
                        const compressedFiles = [];
                        for (const file of files) {
                            if (file.type.startsWith('image/')) {
                                try {
                                    const compressed = await compressImage(file);
                                    compressedFiles.push(compressed);
                                } catch (error) {
                                    console.error('Image compression failed:', error);
                                    compressedFiles.push(file); // 압축 실패 시 원본 사용
                                }
                            } else {
                                compressedFiles.push(file);
                            }
                        }
                        
                        // DataTransfer를 사용해 압축된 파일로 교체
                        const dataTransfer = new DataTransfer();
                        compressedFiles.forEach(file => dataTransfer.items.add(file));
                        e.target.files = dataTransfer.files;
                        
                        // 유효한 파일들 저장 (압축된 파일)
                        selectedFiles = compressedFiles;
                        
                        // 미리보기 생성
                        imagePreviewContainer.innerHTML = '';
                        files.forEach((file, index) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const previewCol = document.createElement('div');
                                previewCol.className = 'col-md-4';
                                previewCol.innerHTML = `
                                    <div class="card">
                                        <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                        <div class="card-body p-2">
                                            <p class="small mb-1 text-truncate">${file.name}</p>
                                            <p class="small text-muted mb-2">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                            <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-image-btn" data-index="${index}">
                                                <i class="bi bi-trash"></i> 삭제
                                            </button>
                                        </div>
                                    </div>
                                `;
                                imagePreviewContainer.appendChild(previewCol);
                                
                                // 삭제 버튼 이벤트 리스너
                                previewCol.querySelector('.remove-image-btn').addEventListener('click', function() {
                                    const indexToRemove = parseInt(this.dataset.index);
                                    removeImage(indexToRemove);
                                });
                            };
                            reader.readAsDataURL(file);
                        });
                    });
                    
                    // 이미지 삭제 함수
                    function removeImage(indexToRemove) {
                        selectedFiles = selectedFiles.filter((_, index) => index !== indexToRemove);
                        
                        // FileList를 DataTransfer로 재구성
                        const dataTransfer = new DataTransfer();
                        selectedFiles.forEach(file => dataTransfer.items.add(file));
                        imageFilesInput.files = dataTransfer.files;
                        
                        // 미리보기 업데이트
                        imagePreviewContainer.innerHTML = '';
                        selectedFiles.forEach((file, index) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const previewCol = document.createElement('div');
                                previewCol.className = 'col-md-4';
                                previewCol.innerHTML = `
                                    <div class="card">
                                        <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                        <div class="card-body p-2">
                                            <p class="small mb-1 text-truncate">${file.name}</p>
                                            <p class="small text-muted mb-2">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                            <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-image-btn" data-index="${index}">
                                                <i class="bi bi-trash"></i> 삭제
                                            </button>
                                        </div>
                                    </div>
                                `;
                                imagePreviewContainer.appendChild(previewCol);
                                
                                previewCol.querySelector('.remove-image-btn').addEventListener('click', function() {
                                    const indexToRemove = parseInt(this.dataset.index);
                                    removeImage(indexToRemove);
                                });
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                }
            });
        </script>
        
        <!-- Ingredients Management Script (모든 공구 유형에서 동작) -->
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('groupBuyForm');
                const addIngredientBtn = document.getElementById('addIngredientBtn');
                const ingredientsList = document.getElementById('ingredientsList');
                
                // ingredientIndex 초기화: 레시피 생성 모드(recipe != null && groupBuy == null)와 공구 수정 모드(ingredientsList != null) 구분
                let ingredientIndex = /*[[${groupBuy == null and recipe != null ? recipe.ingredients.size() : (ingredientsList != null ? ingredientsList.size() : 0)}]]*/ 0;
                
                if (!form) {
                    console.error('필수 요소를 찾을 수 없습니다.');
                    return;
                }
                
                // 기존 재료 항목들에 대한 이벤트 리스너 등록
                document.querySelectorAll('.ingredient-name-input').forEach((nameInput) => {
                    const ingredientItem = nameInput.closest('.ingredient-item');
                    const checkbox = ingredientItem.querySelector('.ingredient-checkbox');
                    
                    // 재료명 변경 시 data-name 속성 업데이트
                    nameInput.addEventListener('input', function() {
                        checkbox.dataset.name = this.value;
                    });
                });
                
                // 기존 재료 항목들의 제거 버튼에 이벤트 리스너 등록
                document.querySelectorAll('.remove-ingredient').forEach((removeBtn) => {
                    removeBtn.addEventListener('click', function() {
                        const ingredientCol = this.closest('.col-md-6');
                        if (ingredientCol) {
                            ingredientCol.remove();
                        }
                    });
                });
                
                // 폼 제출 시 선택된 재료를 JSON으로 변환
                form.addEventListener('submit', function(e) {
                    const ingredientItems = document.querySelectorAll('.ingredient-item');
                    const selectedIngredients = [];
                    
                    ingredientItems.forEach((item) => {
                        const checkbox = item.querySelector('.ingredient-checkbox');
                        if (checkbox && checkbox.checked) {
                            const nameInput = item.querySelector('.ingredient-name-input');
                            const measureInput = item.querySelector('.ingredient-measure');
                            
                            selectedIngredients.push({
                                name: nameInput ? nameInput.value : (checkbox.dataset.name || ''),
                                measure: measureInput ? measureInput.value : '',
                                selected: true
                            });
                        }
                    });
                    
                    // 최소 1개 이상의 재료 필수
                    if (selectedIngredients.length === 0) {
                        e.preventDefault();
                        alert('최소 1개 이상의 재료를 선택해주세요.');
                        return false;
                    }
                    
                    // JSON 문자열로 변환하여 hidden input에 저장
                    let selectedIngredientsInput = document.getElementById('selectedIngredientsJson');
                    if (!selectedIngredientsInput) {
                        selectedIngredientsInput = document.createElement('input');
                        selectedIngredientsInput.type = 'hidden';
                        selectedIngredientsInput.id = 'selectedIngredientsJson';
                        selectedIngredientsInput.name = 'selectedIngredientsJson';
                        form.appendChild(selectedIngredientsInput);
                    }
                    selectedIngredientsInput.value = JSON.stringify(selectedIngredients);
                });
                
                // 재료 추가 버튼
                addIngredientBtn.addEventListener('click', function() {
                    const newIngredient = document.createElement('div');
                    newIngredient.className = 'col-md-6';
                    newIngredient.innerHTML = `
                        <div class="border rounded p-3 ingredient-item">
                            <div class="form-check mb-2">
                                <input class="form-check-input ingredient-checkbox" 
                                       type="checkbox" 
                                       id="ingredient-${ingredientIndex}"
                                       data-name=""
                                       checked>
                                <label class="form-check-label w-100" for="ingredient-${ingredientIndex}">
                                    <input type="text" 
                                           class="form-control form-control-sm d-inline-block ingredient-name-input" 
                                           placeholder="재료명"
                                           required
                                           style="width: 100%;">
                                </label>
                            </div>
                            <input type="text" 
                                   class="form-control form-control-sm ingredient-measure" 
                                   id="measure-${ingredientIndex}"
                                   placeholder="분량 (예: 200g, 2개)">
                            <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-ingredient">
                                <i class="bi bi-trash"></i> 제거
                            </button>
                        </div>
                    `;
                    
                    ingredientsList.appendChild(newIngredient);
                    
                    // 재료명 입력 시 data-name 업데이트
                    const nameInput = newIngredient.querySelector('.ingredient-name-input');
                    const checkbox = newIngredient.querySelector('.ingredient-checkbox');
                    nameInput.addEventListener('input', function() {
                        checkbox.dataset.name = this.value;
                    });
                    
                    // 제거 버튼 이벤트 리스너
                    newIngredient.querySelector('.remove-ingredient').addEventListener('click', function() {
                        newIngredient.remove();
                    });
                    
                    ingredientIndex++;
                });
            });
        </script>
        
        <!-- Kakao Map Integration Script with Daum Postcode API -->
        <script th:inline="javascript">
            // Global variables for map
            let map = null;
            let marker = null;
            let geocoder = null;
            let isMapInitialized = false;
            
            // Toggle map display
            function toggleMapDisplay() {
                const mapContainer = document.getElementById('mapContainer');
                const mapToggleIcon = document.getElementById('mapToggleIcon');
                const mapToggleText = document.getElementById('mapToggleText');
                
                if (mapContainer.style.display === 'none') {
                    mapContainer.style.display = 'block';
                    mapToggleIcon.className = 'bi bi-map-fill';
                    mapToggleText.textContent = '지도 숨기기';
                    
                    // Initialize map if not already initialized
                    if (!isMapInitialized) {
                        initializeDefaultMap();
                    } else {
                        // If map is already initialized, update the center to current coordinates
                        const latitudeInput = document.getElementById('latitude');
                        const longitudeInput = document.getElementById('longitude');
                        const currentLat = latitudeInput.value ? parseFloat(latitudeInput.value) : null;
                        const currentLng = longitudeInput.value ? parseFloat(longitudeInput.value) : null;
                        
                        if (currentLat && currentLng) {
                            const newPosition = new kakao.maps.LatLng(currentLat, currentLng);
                            map.setCenter(newPosition);
                            
                            // Update or create marker
                            if (!marker) {
                                marker = new kakao.maps.Marker({
                                    position: newPosition,
                                    map: map
                                });
                            } else {
                                marker.setPosition(newPosition);
                            }
                        }
                    }
                } else {
                    mapContainer.style.display = 'none';
                    mapToggleIcon.className = 'bi bi-map';
                    mapToggleText.textContent = '지도 보기';
                }
            }
            
            // Initialize map with default location (Seoul City Hall) or existing coordinates
            function initializeDefaultMap() {
                // Wait for Kakao Maps API to load
                if (typeof kakao === 'undefined' || !kakao.maps) {
                    console.log('Kakao Maps API not loaded yet. Retrying...');
                    setTimeout(initializeDefaultMap, 100);
                    return;
                }
                
                // Initialize kakao.maps.load
                kakao.maps.load(function() {
                    const latitudeInput = document.getElementById('latitude');
                    const longitudeInput = document.getElementById('longitude');
                    
                    // Get current coordinates from input fields (for both create and edit mode)
                    const currentLat = latitudeInput.value ? parseFloat(latitudeInput.value) : null;
                    const currentLng = longitudeInput.value ? parseFloat(longitudeInput.value) : null;
                    
                    // Use current coordinates if available, otherwise use default (Seoul City Hall)
                    let defaultLat = currentLat || 37.5665; // Seoul City Hall
                    let defaultLng = currentLng || 126.9780;
                    
                    const mapOption = {
                        center: new kakao.maps.LatLng(defaultLat, defaultLng),
                        level: 3
                    };
                    
                    map = new kakao.maps.Map(document.getElementById('meetupMap'), mapOption);
                    geocoder = new kakao.maps.services.Geocoder();
                    
                    // Add marker if there are current coordinates
                    if (currentLat && currentLng) {
                        marker = new kakao.maps.Marker({
                            position: new kakao.maps.LatLng(defaultLat, defaultLng),
                            map: map
                        });
                    }
                    
                    // Map click event - add/move marker and update address
                    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                        const latlng = mouseEvent.latLng;
                        const newLat = latlng.getLat();
                        const newLng = latlng.getLng();
                        
                        // Create or update marker
                        if (!marker) {
                            marker = new kakao.maps.Marker({
                                position: latlng,
                                map: map
                            });
                        } else {
                            marker.setPosition(latlng);
                        }
                        
                        // Update hidden inputs
                        latitudeInput.value = newLat;
                        longitudeInput.value = newLng;
                        
                        // Reverse geocode to update address
                        geocoder.coord2Address(newLng, newLat, function(result, status) {
                            if (status === kakao.maps.services.Status.OK && result[0]) {
                                const meetupLocationInput = document.getElementById('meetupLocation');
                                const roadAddress = result[0].road_address;
                                const jibunAddress = result[0].address;
                                
                                if (roadAddress) {
                                    meetupLocationInput.value = roadAddress.address_name;
                                } else if (jibunAddress) {
                                    meetupLocationInput.value = jibunAddress.address_name;
                                }
                            }
                        });
                    });
                    
                    isMapInitialized = true;
                });
            }
            
            // Update map location with coordinates
            function updateMapLocation(lat, lng) {
                const newPosition = new kakao.maps.LatLng(lat, lng);
                
                // Ensure map is visible
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer.style.display === 'none') {
                    toggleMapDisplay();
                }
                
                // Wait for map to be initialized
                if (!isMapInitialized) {
                    setTimeout(function() {
                        updateMapLocation(lat, lng);
                    }, 100);
                    return;
                }
                
                // Update map center
                map.setCenter(newPosition);
                
                // Create or update marker
                if (!marker) {
                    marker = new kakao.maps.Marker({
                        position: newPosition,
                        map: map
                    });
                } else {
                    marker.setPosition(newPosition);
                }
            }
            
            // Daum Postcode API integration
            function execDaumPostcode() {
                new daum.Postcode({
                    oncomplete: function(data) {
                        // Get selected address
                        const fullAddress = data.roadAddress || data.jibunAddress;
                        
                        // Update address input
                        const meetupLocationInput = document.getElementById('meetupLocation');
                        meetupLocationInput.value = fullAddress;
                        
                        // Geocode the address to get coordinates
                        if (geocoder) {
                            geocoder.addressSearch(fullAddress, function(result, status) {
                                if (status === kakao.maps.services.Status.OK) {
                                    const lat = parseFloat(result[0].y);
                                    const lng = parseFloat(result[0].x);
                                    
                                    // Update hidden inputs
                                    document.getElementById('latitude').value = lat;
                                    document.getElementById('longitude').value = lng;
                                    
                                    // Update map
                                    updateMapLocation(lat, lng);
                                }
                            });
                        } else {
                            // Wait for geocoder to be initialized
                            setTimeout(function() {
                                execDaumPostcode();
                            }, 100);
                        }
                    },
                    theme: {
                        searchBgColor: "#FF6B35", // primary color
                        queryTextColor: "#FFFFFF"
                    }
                }).open();
            }
            
            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function() {
                const searchAddressBtn = document.getElementById('searchAddressBtn');
                const mapContainer = document.getElementById('mapContainer');
                
                // Check if Kakao Maps API is available
                if (typeof kakao === 'undefined' || !kakao.maps) {
                    console.log('Kakao Maps API not loaded. Map features will be disabled.');
                    searchAddressBtn.disabled = true;
                    searchAddressBtn.innerHTML = '<i class="bi bi-exclamation-circle"></i> 지도 서비스 이용 불가';
                    return;
                }
                
                // Check if Daum Postcode API is available
                if (typeof daum === 'undefined' || !daum.Postcode) {
                    console.log('Daum Postcode API not loaded. Falling back to text input.');
                    const meetupLocationInput = document.getElementById('meetupLocation');
                    meetupLocationInput.removeAttribute('readonly');
                    meetupLocationInput.placeholder = '주소를 직접 입력하세요';
                }
                
                // Initialize geocoder when Kakao Maps is loaded
                kakao.maps.load(function() {
                    geocoder = new kakao.maps.services.Geocoder();
                });
                
                // Add click event to search button
                searchAddressBtn.addEventListener('click', function() {
                    if (typeof daum !== 'undefined' && daum.Postcode) {
                        execDaumPostcode();
                    } else {
                        alert('주소 검색 서비스를 사용할 수 없습니다.');
                    }
                });
                
                // If editing with existing coordinates, show map
                const existingLat = /*[[${formData.latitude}]]*/ null;
                const existingLng = /*[[${formData.longitude}]]*/ null;
                
                if (existingLat && existingLng) {
                    mapContainer.style.display = 'block';
                    document.getElementById('mapToggleIcon').className = 'bi bi-map-fill';
                    document.getElementById('mapToggleText').textContent = '지도 숨기기';
                    initializeDefaultMap();
                }
            });
        </script>
    </th:block>
</body>
</html>
