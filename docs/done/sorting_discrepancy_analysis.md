# H2(로컬)와 PostgreSQL(배포) 간 레시피 이름순 정렬 차이 분석

## 1. 문제 현상

- **기능**: 레시피 목록을 '이름순'으로 정렬합니다.
- **현상**: 로컬 환경(H2 DB)과 배포 환경(PostgreSQL DB)에서 동일한 정렬 로직을 사용함에도 불구하고, 한글, 영어, 숫자가 포함된 레시피 제목의 정렬 결과가 다르게 나타납니다.
    - **로컬 (H2)**: `숫자 -> 영어 -> 한글` 순서로 예상대로 정렬됩니다.
    - **배포 (PostgreSQL)**: 영어와 한글 순서가 섞여서 정렬되는 등 비일관적인 결과를 보입니다.

## 2. 원인 분석

코드 분석 결과, 애플리케이션은 정렬 요청 시 Spring Data JPA의 `Sort.by("title")`을 사용하여 `ORDER BY title` SQL 구문을 정상적으로 생성하고 있었습니다. 문제는 코드가 아닌 **데이터베이스 시스템 간의 기본 `Collation` 설정 차이**에 있습니다.

- **`Collation`이란?**: 데이터베이스에서 문자열을 정렬하는 규칙의 집합입니다. 어떤 언어의 문자 순서를 따를지, 대소문자를 구분할지 등을 정의합니다.

- **`schema.sql` 분석**:
  ```sql
  CREATE TABLE recipes (
      -- ... 다른 컬럼들
      title VARCHAR(200) NOT NULL,
      -- ... 다른 컬럼들
  );
  ```
  `recipes` 테이블의 `title` 컬럼 정의에 별도의 `COLLATE` 구문이 명시되어 있지 않습니다. 이 경우, 각 데이터베이스는 시스템의 기본(default) Collation 설정을 따르게 됩니다.

- **H2의 동작**: 로컬에서 사용하는 H2 데이터베이스는 JVM(자바 가상 머신)의 로캘 설정을 기반으로 한 Collation을 사용합니다. 이 Collation은 일반적으로 유니코드 문자 순서를 잘 이해하여 사용자가 기대하는 `숫자 -> 영어 -> 한글` 순으로 정렬합니다.

- **PostgreSQL의 동작**: 배포 환경의 PostgreSQL은 설치된 OS나 Docker 컨테이너의 기본 `LC_COLLATE` 설정을 따릅니다. 이 설정이 `C` 또는 `POSIX`와 같이 기본적인 바이트 순서(byte order)로 지정된 경우, 문자 고유의 바이트 값에 따라 정렬합니다. 이 방식에서는 한글과 영어의 바이트 순서가 섞여 있어 '가나다' 순이나 'abc' 순이 아닌, 예측하기 어려운 결과가 나타납니다.

## 3. 해결 방안

모든 환경에서 일관된 정렬 결과를 보장하기 위해, `title` 컬럼에 명시적으로 Collation을 지정해야 합니다. 가장 표준적이고 예측 가능한 방법은 **`C` Collation을 사용**하는 것입니다. 이는 로캘(언어)에 구애받지 않고 문자의 코드포인트(바이트 값)를 기준으로 정렬하여, 어느 시스템에서나 동일한 순서를 보장합니다.

UTF-8 인코딩 환경에서 `C` Collation은 일반적으로 `숫자 -> 영어 -> 한글` 순서와 유사한 결과를 제공하여 현재 로컬 환경의 정렬 방식과 일치하게 됩니다.

### 수정 제안

`schema.sql` 파일의 `recipes` 테이블 생성 구문을 다음과 같이 수정합니다.

```sql
-- 수정 전
title VARCHAR(200) NOT NULL,

-- 수정 후
title VARCHAR(200) COLLATE "C" NOT NULL,
```

따라서 현재 운영 중인 PostgreSQL 데이터베이스의 정렬 문제를 즉시 해결하기 위해서는 psql 등을
통해 직접 데이터베이스에 접속하여 ALTER TABLE 명령을 실행해야 합니다.

해당 명령은 다음과 같습니다.

`ALTER TABLE recipes ALTER COLUMN title TYPE VARCHAR(200) COLLATE "C";`

이 변경을 통해 PostgreSQL 데이터베이스가 `title` 컬럼을 정렬할 때 표준 `C` Collation을 사용하도록 강제할 수 있습니다. 결과적으로 로컬, 개발, 운영 등 모든 환경에서 레시피 이름순 정렬이 일관되게 동작하게 될 것입니다.
