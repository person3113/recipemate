# 회원가입 기능 개선 및 오류 해결 계획

## 1. 문제 분석

### 1.1. 500 서버 오류: 소프트 삭제 계정 이메일 재사용 불가

- **현상**: 소프트 삭제(soft-deleted)된 사용자와 동일한 이메일로 신규 회원가입 시, `org.hibernate.exception.ConstraintViolationException`이 발생하며 500 에러로 이어집니다.
- **원인**: `USERS` 테이블의 `email` 컬럼에 `UNIQUE` 제약조건이 설정되어 있습니다. 소프트 삭제는 데이터베이스에서 행을 실제로 삭제하는 것이 아니라 `deleted_at`과 같은 상태 값만 변경하는 방식입니다. 따라서 이메일 주소는 여전히 테이블에 남아있어, 신규 가입 시도 시 데이터베이스 레벨에서 중복으로 간주되어 제약조건 위반 오류가 발생합니다.

### 1.2. 초기 기획 기능 미반영

- **현상**: 현재 회원가입 페이지는 이메일, 비밀번호, 닉네임, 전화번호를 한 번에 제출하는 단순 폼(Form) 형태입니다.
- **문제점**: `docs/project_plan/8_회원가입_로그인.md`에 명시된 아래와 같은 핵심 사용자 경험(UX) 기능들이 누락되어 있습니다.
    - 이메일 및 닉네임 중복 실시간 확인 기능
    - 비밀번호 일치 여부 실시간 검증
    - 전화번호 자동 하이픈(-) 추가
    - 모든 조건 충족 시에만 [가입하기] 버튼 활성화

## 2. 해결 방안

`htmx`와 Spring Boot를 조합하여, 페이지 새로고침 없는 동적이고 사용자 친화적인 회원가입 프로세스를 구현합니다.

### 2.1. 소프트 삭제 계정 처리 방안

`UserService`의 `signup` 로직과 이메일 중복 검사 로직을 수정하여, 소프트 삭제된 계정을 올바르게 처리합니다.

1.  **UserRepository 변경**:
    - 소프트 삭제된 사용자를 포함하여 이메일로 사용자를 조회하는 메서드를 추가합니다. JPA의 기본 `findByEmail`은 활성 레코드만 가져오는 경우가 많으므로, 삭제 여부와 관계없이 조회하는 네이티브 쿼리 또는 별도 메서드가 필요합니다.
    - 예: `findFirstByEmailOrderByCreatedAtDesc(String email)`

2.  **AuthService/UserService 로직 수정**:
    - **(신규)** 이메일 중복 검사 시, 위에서 추가한 메서드를 사용하여 소프트 삭제된 계정까지 모두 확인합니다.
    - 조회된 사용자가 존재할 경우:
        - **소프트 삭제된 계정인 경우**: "이미 사용된 이메일입니다. 관리자에게 문의하세요."와 같이 명확한 메시지를 반환하여 사용자의 혼란을 줄입니다. 이는 사용자가 의도치 않게 과거 계정을 덮어쓰거나 데이터가 꼬이는 것을 방지하는 가장 안전한 정책입니다.
        - **활성 계정인 경우**: 기존과 동일하게 "이미 사용 중인 이메일입니다." 메시지를 반환합니다.
    - 최종 `signup` 메서드에서도 동일한 검증 로직을 한 번 더 수행하여 데이터 무결성을 보장합니다.

### 2.2. 회원가입 기능 동적 구현 (htmx 활용)

`AuthController`에 `htmx` 요청을 처리하는 엔드포인트를 추가하고, `signup.html`을 수정하여 동적인 검증을 구현합니다.

1.  **Backend (Controller)**:
    - **이메일 중복 확인 API 추가**:
        - **URL**: `POST /auth/check-email`
        - **로직**: 요청 본문(body)에서 이메일을 받아 `UserService`를 통해 중복 여부(소프트 삭제 포함)를 확인합니다.
        - **응답**: 결과를 담은 HTML 조각(fragment)을 반환합니다. (예: `<div class="text-success">사용 가능한 이메일입니다.</div>`)
    - **닉네임 중복 확인 API 추가**:
        - **URL**: `POST /auth/check-nickname`
        - **로직**: 이메일 중복 확인과 동일한 방식으로 닉네임 중복을 검사하고 HTML 조각을 반환합니다.

2.  **Frontend (signup.html)**:
    - **UI 변경**:
        - 이메일과 닉네임 필드 옆에 **[중복확인]** 버튼을 추가합니다.
        - 비밀번호 확인을 위한 `<input>` 필드를 추가합니다.
        - 각 필드 아래에 검증 결과를 표시할 `<div>` 영역을 추가합니다.
    - **htmx 적용**:
        - **[중복확인]** 버튼에 `htmx` 속성을 추가하여 클릭 시 위에서 만든 API(`check-email`, `check-nickname`)를 호출하도록 설정합니다.
            - `hx-post`: `/auth/check-email`
            - `hx-trigger`: `click`
            - `hx-target`: 서버 응답을 표시할 `<div>` ID
            - `hx-swap`: `innerHTML`
    - **JavaScript 강화**:
        - **비밀번호 검증**: `input` 이벤트 리스너를 사용해 비밀번호와 비밀번호 확인 필드의 값이 일치하는지, 8자 이상인지 실시간으로 검사하고 메시지를 업데이트합니다.
        - **전화번호 자동 하이픈**: `input` 이벤트 리스너를 사용해 `010-xxxx-xxxx` 형식으로 자동 변환하고, 숫자 외 문자는 입력되지 않도록 막습니다.
        - **[가입하기] 버튼 제어**: 페이지 로드 시 버튼을 `disabled` 상태로 두고, 모든 유효성 검사(이메일/닉네임 중복 확인 완료, 비밀번호 일치 등)가 통과되었을 때만 활성화합니다.

## 3. 예상 작업 단계

1.  `UserRepository`에 소프트 삭제된 유저를 포함하여 이메일로 조회하는 메서드 추가.
2.  `UserService` 및 `AuthService`에 소프트 삭제 계정을 처리하는 이메일 중복 검사 로직 구현.
3.  `AuthController`에 이메일/닉네임 중복 확인을 위한 `htmx`용 엔드포인트(`check-email`, `check-nickname`) 추가.
4.  `signup.html`에 중복확인 버튼, 비밀번호 확인 필드, 결과 표시 영역 등 UI 요소 추가.
5.  `signup.html`에 `htmx` 속성을 적용하여 비동기 중복 검사 기능 연동.
6.  `signup.html`에 비밀번호 일치 여부, 전화번호 자동 하이픈, 가입 버튼 활성화/비활성화를 위한 JavaScript 코드 작성.
7.  전체 기능 테스트 (정상 가입, 중복 이메일, 소프트 삭제된 이메일, 중복 닉네임 등 다양한 시나리오 검증).
