<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
    <!-- Footer Fragment -->
    <th:block th:fragment="footer">
        <footer class="mt-auto py-4 bg-dark text-white">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                        <h5 class="mb-1 fw-bold">
                            <i class="bi bi-basket text-primary"></i> RecipeMate
                        </h5>
                        <p class="mb-0 small text-muted">레시피 기반 공동구매 플랫폼</p>
                    </div>
                    <div class="col-md-6 text-center text-md-end">
                        <p class="mb-0 small text-muted">
                            &copy; 2025 RecipeMate. All rights reserved.
                        </p>
                    </div>
                </div>
            </div>
        </footer>
        
        <!-- Lazy Loading Script -->
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                const lazyImages = document.querySelectorAll('img.lazy-load');
                
                // Use Intersection Observer for lazy loading
                if ('IntersectionObserver' in window) {
                    const imageObserver = new IntersectionObserver(function(entries, observer) {
                        entries.forEach(function(entry) {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                const src = img.getAttribute('data-src');
                                if (src) {
                                    img.src = src;
                                    img.classList.remove('lazy-load');
                                    img.classList.add('lazy-loaded');
                                    imageObserver.unobserve(img);
                                }
                            }
                        });
                    }, {
                        rootMargin: '50px 0px', // Start loading 50px before entering viewport
                        threshold: 0.01
                    });
                    
                    lazyImages.forEach(function(img) {
                        imageObserver.observe(img);
                    });
                } else {
                    // Fallback for browsers that don't support Intersection Observer
                    lazyImages.forEach(function(img) {
                        const src = img.getAttribute('data-src');
                        if (src) {
                            img.src = src;
                        }
                    });
                }
            });
        </script>
        
        <!-- Search Autocomplete Script -->
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                const searchInput = document.getElementById('search-input');
                const autocompleteDropdown = document.getElementById('search-autocomplete');
                const autocompleteList = document.getElementById('autocomplete-list');
                
                if (!searchInput || !autocompleteDropdown || !autocompleteList) return;
                
                let debounceTimer;
                let currentKeywords = [];
                let selectedIndex = -1;
                const RECENT_SEARCH_KEY = 'recentSearchKeywords';
                const MAX_RECENT = 5;
                
                // 로컬스토리지에서 최근 검색어 불러오기
                function getRecentKeywords() {
                    try {
                        const recent = localStorage.getItem(RECENT_SEARCH_KEY);
                        return recent ? JSON.parse(recent) : [];
                    } catch (e) {
                        console.error('최근 검색어 로드 실패:', e);
                        return [];
                    }
                }
                
                // 최근 검색어 저장
                function saveRecentKeyword(keyword) {
                    try {
                        let recent = getRecentKeywords();
                        // 중복 제거
                        recent = recent.filter(k => k !== keyword);
                        // 맨 앞에 추가
                        recent.unshift(keyword);
                        // 최대 개수 제한
                        recent = recent.slice(0, MAX_RECENT);
                        localStorage.setItem(RECENT_SEARCH_KEY, JSON.stringify(recent));
                    } catch (e) {
                        console.error('최근 검색어 저장 실패:', e);
                    }
                }
                
                // 최근 검색어 삭제
                function removeRecentKeyword(keyword) {
                    try {
                        let recent = getRecentKeywords();
                        recent = recent.filter(k => k !== keyword);
                        localStorage.setItem(RECENT_SEARCH_KEY, JSON.stringify(recent));
                        // 삭제 후 다시 렌더링
                        loadCombinedKeywords();
                    } catch (e) {
                        console.error('최근 검색어 삭제 실패:', e);
                    }
                }
                
                // 인기 검색어 불러오기
                function loadPopularKeywords() {
                    return fetch('/search/popular-keywords?limit=10')
                        .then(response => response.json())
                        .catch(error => {
                            console.error('인기 검색어 로드 실패:', error);
                            return [];
                        });
                }
                
                // 통합 검색어 목록 로드 (최근 검색어 + 인기 검색어)
                function loadCombinedKeywords() {
                    const recent = getRecentKeywords();
                    loadPopularKeywords().then(popular => {
                        const combined = [];
                        
                        // 최근 검색어 추가
                        if (recent.length > 0) {
                            combined.push({ type: 'recent', keywords: recent });
                        }
                        
                        // 인기 검색어 추가 (최근 검색어와 중복 제거)
                        const uniquePopular = popular.filter(k => !recent.includes(k));
                        if (uniquePopular.length > 0) {
                            combined.push({ type: 'popular', keywords: uniquePopular });
                        }
                        
                        renderAutocomplete(combined);
                    });
                }
                
                // 자동완성 목록 렌더링
                function renderAutocomplete(sections) {
                    autocompleteList.innerHTML = '';
                    
                    if (!sections || sections.length === 0) {
                        autocompleteDropdown.style.display = 'none';
                        return;
                    }
                    
                    let totalIndex = 0;
                    sections.forEach(section => {
                        if (section.keywords.length === 0) return;
                        
                        // 섹션 헤더
                        const header = document.createElement('div');
                        header.className = 'autocomplete-header text-muted small px-3 py-2';
                        if (section.type === 'recent') {
                            header.innerHTML = '<i class="bi bi-clock-history text-primary"></i> 최근 검색어';
                        } else {
                            header.innerHTML = '<i class="bi bi-star-fill text-warning"></i> 인기 검색어';
                        }
                        autocompleteList.appendChild(header);
                        
                        // 키워드 목록
                        section.keywords.forEach(keyword => {
                            const li = document.createElement('li');
                            li.className = 'd-flex align-items-center justify-content-between';
                            li.dataset.index = totalIndex++;
                            li.dataset.keyword = keyword;
                            li.style.cursor = 'pointer';
                            
                            // 키워드 표시 영역
                            const keywordSpan = document.createElement('span');
                            keywordSpan.className = 'flex-grow-1';
                            if (section.type === 'recent') {
                                keywordSpan.innerHTML = '<i class="bi bi-clock-history me-2"></i>' + keyword;
                            } else {
                                keywordSpan.innerHTML = '<i class="bi bi-search me-2"></i>' + keyword;
                            }
                            
                            li.appendChild(keywordSpan);
                            
                            // 최근 검색어에만 삭제 버튼 추가
                            if (section.type === 'recent') {
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'btn btn-sm btn-link text-muted p-0 ms-2';
                                deleteBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
                                deleteBtn.title = '삭제';
                                deleteBtn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    removeRecentKeyword(keyword);
                                });
                                li.appendChild(deleteBtn);
                            }
                            
                            // li 전체 영역 클릭 시 검색 (삭제 버튼 제외)
                            li.addEventListener('click', function(e) {
                                // 삭제 버튼 클릭이 아닌 경우에만 검색 실행
                                if (e.target.closest('button')) {
                                    return;
                                }
                                e.preventDefault();
                                searchInput.value = keyword;
                                saveRecentKeyword(keyword);
                                autocompleteDropdown.style.display = 'none';
                                // 약간의 지연 후 제출하여 DOM 업데이트 완료 보장
                                setTimeout(() => {
                                    searchInput.form.submit();
                                }, 10);
                            });
                            
                            autocompleteList.appendChild(li);
                        });
                    });
                    
                    autocompleteDropdown.style.display = 'block';
                }
                
                // 키보드 네비게이션
                function updateSelection(index) {
                    const items = autocompleteList.querySelectorAll('li');
                    items.forEach(item => item.classList.remove('active'));
                    
                    if (index >= 0 && index < items.length) {
                        items[index].classList.add('active');
                        selectedIndex = index;
                    } else {
                        selectedIndex = -1;
                    }
                }
                
                // 입력 이벤트
                searchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    
                    const value = this.value.trim();
                    
                    if (value.length === 0) {
                        // 입력이 없으면 최근 검색어 + 인기 검색어 표시
                        loadCombinedKeywords();
                    } else {
                        // 입력이 있으면 필터링된 결과 표시
                        debounceTimer = setTimeout(() => {
                            const recent = getRecentKeywords().filter(k => 
                                k.toLowerCase().includes(value.toLowerCase())
                            );
                            
                            loadPopularKeywords().then(popular => {
                                const filteredPopular = popular.filter(k => 
                                    k.toLowerCase().includes(value.toLowerCase()) && !recent.includes(k)
                                );
                                
                                const combined = [];
                                if (recent.length > 0) {
                                    combined.push({ type: 'recent', keywords: recent });
                                }
                                if (filteredPopular.length > 0) {
                                    combined.push({ type: 'popular', keywords: filteredPopular });
                                }
                                
                                renderAutocomplete(combined);
                            });
                        }, 200);
                    }
                });
                
                // 포커스 시 최근 검색어 + 인기 검색어 표시
                searchInput.addEventListener('focus', function() {
                    if (this.value.trim().length === 0) {
                        loadCombinedKeywords();
                    }
                });
                
                // 키보드 네비게이션
                searchInput.addEventListener('keydown', function(e) {
                    const items = autocompleteList.querySelectorAll('li');
                    
                    if (items.length === 0) return;
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        updateSelection((selectedIndex + 1) % items.length);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        updateSelection(selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1);
                    } else if (e.key === 'Enter') {
                        if (selectedIndex >= 0 && selectedIndex < items.length) {
                            e.preventDefault();
                            const keyword = items[selectedIndex].dataset.keyword;
                            searchInput.value = keyword;
                            saveRecentKeyword(keyword);
                            autocompleteDropdown.style.display = 'none';
                            // 약간의 지연 후 제출하여 DOM 업데이트 완료 보장
                            setTimeout(() => {
                                searchInput.form.submit();
                            }, 10);
                        } else {
                            // Enter 키로 검색 시 최근 검색어에 추가
                            const keyword = this.value.trim();
                            if (keyword) {
                                saveRecentKeyword(keyword);
                            }
                        }
                    } else if (e.key === 'Escape') {
                        autocompleteDropdown.style.display = 'none';
                        selectedIndex = -1;
                    }
                });
                
                // 검색 폼 제출 시 최근 검색어 저장
                searchInput.form.addEventListener('submit', function() {
                    const keyword = searchInput.value.trim();
                    if (keyword) {
                        saveRecentKeyword(keyword);
                    }
                });
                
                // 외부 클릭 시 드롭다운 닫기
                document.addEventListener('click', function(e) {
                    if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
                        autocompleteDropdown.style.display = 'none';
                        selectedIndex = -1;
                    }
                });
            });
        </script>
    </th:block>
</body>
</html>
